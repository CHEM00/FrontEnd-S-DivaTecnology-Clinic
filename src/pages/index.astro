---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Inicio de Sesión">
  <div
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#eafaf1] via-[#d0ecd7] to-[#b2d8c5] relative overflow-hidden"
  >
    {/* Logo decorativo grande, aún más sutil y difuminado */}
    <img
      src="/LogoJess.png"
      alt="Logo de la clínica"
      class="pointer-events-none select-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[420px] h-[420px] opacity-7 blur-[60px] object-contain z-0"
      aria-hidden="true"
    />
    {/* Card de login con efecto liquid glass */}
    <form
      id="loginForm"
      class="relative z-10 w-full max-w-md mx-4
        rounded-[2.5rem] border border-white/30
        bg-white/30 backdrop-blur-2xl shadow-2xl
        flex flex-col gap-6 items-center
        p-8 md:p-12
        ring-1 ring-[#b2d8c5]/40"
      style="box-shadow: 0 12px 48px 0 rgba(35,77,32,0.10), 0 1.5px 8px 0 rgba(178,216,197,0.10);"
    >
      {/* Logo pequeño centrado */}
      <img
        src="/LogoJess.png"
        alt="Logo de la clínica"
        class="w-32 h-32 object-contain rounded-full shadow-lg mb-2 border-2 border-white/60 bg-white/70"
      />
      <span class="text-2xl font-bold text-[#234D20] drop-shadow"
        >Inicio de sesión</span
      >
      {/* Campos de login */}
      <div class="flex flex-col gap-4 w-full">
        <input
          id="username"
          type="text"
          placeholder="Usuario"
          class="px-4 py-2 rounded-xl border border-gray-200 bg-white/60 backdrop-blur focus:outline-none focus:ring-2 focus:ring-[#388e3c]/40 transition placeholder:text-gray-500"
          required
        />
        <input
          id="password"
          type="password"
          placeholder="Contraseña"
          class="px-4 py-2 rounded-xl border border-gray-200 bg-white/60 backdrop-blur focus:outline-none focus:ring-2 focus:ring-[#388e3c]/40 transition placeholder:text-gray-500"
          required
        />
      </div>
      <button
        type="submit"
        class="w-full py-2 rounded-xl font-semibold shadow-sm transition
          bg-[#234D20] hover:bg-[#388e3c] focus:bg-[#256029]
          text-white text-base tracking-wide
          focus:outline-none focus:ring-2 focus:ring-[#388e3c]/40
          duration-200"
      >
        Iniciar sesión
      </button>
      <div class="text-center space-y-2 w-full">
        <p class="text-sm text-gray-700 drop-shadow-sm">
          Acceso exclusivo para personal médico autorizado
        </p>
        <p class="text-sm">
          Si eres paciente, da click
          <a href="/LogPaciente" class="text-green-800 underline">aquí</a>
          para visualizar tu historial clínico
        </p>
      </div>
    </form>
  </div>
</Layout>

<script>
  const loginForm = document.getElementById("loginForm");

  if (loginForm) {
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const usernameInput = document.getElementById(
        "username",
      ) as HTMLInputElement;
      const passwordInput = document.getElementById(
        "password",
      ) as HTMLInputElement;

      const username = usernameInput?.value;
      const password = passwordInput?.value;

      try {
        const response = await fetch("/api/v1/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: username, password: password }),
        });

        const data = await response.json();

        if (data.token) {
          // 1. Guardar Token en Cookie (CRÍTICO para el Middleware)
          // Usamos path=/ para que esté disponible en toda la app
          // Max-age 86400 = 1 día
          document.cookie = `auth_token=${data.token}; path=/; max-age=86400; SameSite=Lax`;

          // 2. Guardar datos en localStorage (Opcional, para uso cliente)
          localStorage.setItem("token", data.token);
          if (data.user) {
            localStorage.setItem("user", JSON.stringify(data.user));
          }

          // 3. Redirección basada en Rol
          const roleId = Number(data.user?.idrol);

          // Pequeño delay para asegurar que el navegador procese la cookie
          setTimeout(() => {
            if (roleId === 3) {
              window.location.href = "/dashboardEmpleado";
            } else if (roleId === 2) {
              window.location.href = "/dashboardAdmin";
            } else {
              // Si no coincide, mandamos al admin por defecto o mostramos error
              console.warn("Rol desconocido, redirigiendo a Admin");
              window.location.href = "/dashboardAdmin";
            }
          }, 100);
        } else {
          alert(data.message || "Credenciales incorrectas");
        }
      } catch (error) {
        console.error("Error de red:", error);
        alert("Error al conectar con el servidor");
      }
    });
  }
</script>
