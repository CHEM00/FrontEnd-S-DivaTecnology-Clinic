---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import NavBar from "../components/NavBar.astro";
import TopTag from "../components/TopTag.astro";
import FormModal from "../components/modals/FormModal.astro";
import axios from "axios";

let table = [];
try {
    const response = await axios.get(
        "http://localhost:3001/api/v1/Permisos/Clinica/1",
    );
    table = response.data;
} catch (error) {
    console.error("Error fetching data:", error);
    table = [];
}

// Función para escapar caracteres problemáticos en JavaScript
const escapeJS = (str) => {
    if (!str) return "";
    return String(str)
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, "\\n")
        .replace(/\r/g, "\\r");
};
---

<Layout title="Permisos">
    <div
        class="flex h-[100dvh] overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
    >
        <NavBar />
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <!-- Background Elements -->
            <div
                class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
            >
            </div>
            <div
                class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
            >
            </div>

            <TopTag
                titulo="Gestión de Permisos"
                nombreUsuario="Administrador"
            />

            <main
                class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
            >
                <!-- Header con título y botones -->
                <div
                    class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 animate-fade-in-up stagger-1"
                >
                    <div>
                        <h1
                            class="text-3xl font-bold text-[#2F5D50] tracking-tight"
                        >
                            Lista de Permisos
                        </h1>
                        <p class="text-gray-500 mt-1">
                            Administra los permisos del sistema
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <a
                            href="/Roles"
                            class="glass-button px-5 py-2.5 rounded-xl flex items-center gap-2 text-[#2F5D50] font-medium hover:bg-white/60 transition-all shadow-sm border border-[#2F5D50]/20"
                        >
                            <i class="fa-solid fa-users"></i>
                            Ver Roles
                        </a>
                    </div>
                </div>

                <!-- Tabla Container -->
                <div
                    class="glass-panel rounded-3xl overflow-hidden animate-fade-in-up stagger-2 border border-white/40 shadow-xl"
                >
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-[#2F5D50]/5 text-[#2F5D50] border-b border-[#2F5D50]/10"
                                >
                                    <th
                                        class="p-5 font-bold text-center w-16 rounded-tl-2xl"
                                        >Sel</th
                                    >
                                    <th class="p-5 font-bold">Permiso</th>
                                    <th class="p-5 font-bold">Rol Asignado</th>
                                    <th
                                        class="p-5 font-bold text-center w-32 rounded-tr-2xl"
                                        >Acciones</th
                                    >
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#2F5D50]/5">
                                {
                                    table.map((permiso) => {
                                        const nombreEscaped = escapeJS(
                                            permiso.Nombre,
                                        );
                                        const rolEscaped = escapeJS(
                                            permiso.NombreRol,
                                        );

                                        return (
                                            <tr class="hover:bg-white/60 transition-colors group">
                                                <td class="p-5 text-center">
                                                    <div class="flex items-center justify-center">
                                                        <input
                                                            type="checkbox"
                                                            class="permiso-checkbox w-5 h-5 rounded-md border-gray-300 text-[#2F5D50] focus:ring-[#2F5D50] cursor-pointer"
                                                            value={permiso.id}
                                                        />
                                                    </div>
                                                </td>
                                                <td class="p-5">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 rounded-full bg-[#2F5D50]/10 flex items-center justify-center text-[#2F5D50]">
                                                            <i class="fa-solid fa-shield-halved" />
                                                        </div>
                                                        <div class="font-bold text-gray-800 text-lg">
                                                            {permiso.Nombre}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="p-5">
                                                    <span class="px-4 py-1.5 rounded-full bg-[#2F5D50]/10 text-[#2F5D50] text-sm font-bold border border-[#2F5D50]/20">
                                                        {permiso.NombreRol}
                                                    </span>
                                                </td>
                                                <td class="p-5 text-center">
                                                    <button
                                                        class="w-8 h-8 rounded-full bg-white/50 hover:bg-[#2F5D50] hover:text-white text-[#2F5D50] transition-all shadow-sm flex items-center justify-center mx-auto"
                                                        onclick={`abrirModalAcciones(${permiso.id}, '${nombreEscaped}', '${rolEscaped}')`}
                                                        title="Acciones"
                                                    >
                                                        <i class="fa-solid fa-ellipsis-vertical" />
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div
                        class="p-4 border-t border-[#2F5D50]/10 flex justify-between items-center bg-white/30 backdrop-blur-sm"
                    >
                        <div class="text-sm text-gray-600 font-medium">
                            Mostrando <span class="font-bold text-[#2F5D50]"
                                >{table.length}</span
                            > permisos
                        </div>
                        <div class="flex gap-2">
                            <button
                                class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:hover:bg-white/50 disabled:hover:text-[#2F5D50] shadow-sm"
                                disabled
                            >
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <button
                                class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all shadow-sm"
                            >
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Acciones -->
    <div
        id="modalAcciones"
        class="fixed inset-0 z-50 hidden"
        aria-labelledby="modal-title"
        role="dialog"
        aria-modal="true"
    >
        <div
            class="fixed inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
            onclick="cerrarModal('modalAcciones')"
        >
        </div>
        <div
            class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
        >
            <div
                class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg p-6"
            >
                <div class="absolute right-4 top-4">
                    <button
                        type="button"
                        class="text-gray-400 hover:text-gray-500"
                        onclick="cerrarModal('modalAcciones')"
                    >
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <div class="text-center mb-6">
                    <h3
                        class="text-xl font-bold text-[#2F5D50]"
                        id="modal-title"
                    >
                        Acciones de Permiso
                    </h3>
                    <p class="text-sm text-gray-500 mt-2">
                        Gestionar permiso: <span
                            id="nombrePermisoAcciones"
                            class="font-bold text-[#2F5D50]"></span>
                    </p>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <button
                        id="btnEditarAccion"
                        class="flex flex-col items-center justify-center p-4 rounded-xl border border-[#2F5D50]/20 hover:bg-[#2F5D50]/5 transition-all group"
                    >
                        <div
                            class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform"
                        >
                            <i class="fa-solid fa-pen-to-square text-xl"></i>
                        </div>
                        <span class="font-medium text-gray-700"
                            >Editar Permiso</span
                        >
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let permisoSeleccionado = null;
        let permisoData = {};

        // Función para verificar checkbox seleccionado
        function verificarCheckboxSeleccionado(id) {
            const idNum = Number(id);
            if (isNaN(idNum)) return false;

            const checkbox = document.querySelector(
                `.permiso-checkbox[value="${id}"]`,
            );
            if (!checkbox || !checkbox.checked) {
                alert("Por favor, seleccione el permiso marcando la casilla.");
                return false;
            }
            return true;
        }

        // Abrir modal de acciones
        window.abrirModalAcciones = function (id, nombre, rol) {
            if (!verificarCheckboxSeleccionado(id)) return;

            permisoSeleccionado = Number(id);
            permisoData = { nombre, rol };

            document.getElementById("nombrePermisoAcciones").textContent =
                nombre;
            document.getElementById("modalAcciones").classList.remove("hidden");
        };

        // Cerrar modales
        window.cerrarModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add("hidden");
        };

        // Event Listeners
        document.addEventListener("DOMContentLoaded", function () {
            // GSAP Animations
            // GSAP Animations
            // if (typeof gsap !== "undefined") {
            //     gsap.from(".glass-panel", {
            //         duration: 0.8,
            //         y: 30,
            //         opacity: 0,
            //         stagger: 0.1,
            //         ease: "power3.out",
            //     });
            //     gsap.from("tr", {
            //         duration: 0.5,
            //         opacity: 0,
            //         y: 10,
            //         stagger: 0.05,
            //         delay: 0.2,
            //         ease: "power2.out",
            //     });
            // }
        });
    </script>
</Layout>
