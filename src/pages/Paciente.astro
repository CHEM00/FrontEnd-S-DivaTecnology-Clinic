---
import Layout from "../layouts/Layout.astro";
import NavBar from "../components/NavBar.astro";
import TopTag from "../components/TopTag.astro";
import FormModal from "../components/modals/FormModal.astro";

interface Paciente {
	id: number;
	firstname: string;
	lastname: string;
	motherlastname: string;
	birthday: string;
	phone: string;
	email: string;
	photo: string;
	created_at: string;
	updated_at: string;
}

let pacientes: Paciente[] = [];
let error = "";

try {
	const response = await fetch("http://localhost:3001/api/v1/Pacientes");
	if (response.ok) {
		const data = await response.json();
		if (Array.isArray(data)) {
			pacientes = data;
		} else if (data && Array.isArray(data.body)) {
			pacientes = data.body;
		} else {
			pacientes = [];
		}
	} else {
		error = "Error al cargar los pacientes";
	}
} catch (e) {
	console.error("Error de conexión:", e);
	error = "Error de conexión con el servidor";
}
---

<Layout title="Pacientes">
	<div
		class="flex h-[100dvh] overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
	>
		<NavBar />
		<div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
			<!-- Background Elements for depth -->
			<div
				class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
			>
			</div>
			<div
				class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
			>
			</div>

			<TopTag
				titulo="Gestión de Pacientes"
				nombreUsuario="Administrador"
			/>

			<main
				class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
			>
				<!-- Header con título y botón agregar -->
				<div
					class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 animate-fade-in-up stagger-1"
				>
					<div>
						<h1
							class="text-3xl font-bold text-[#2F5D50] tracking-tight"
						>
							Lista de Pacientes
						</h1>
						<p class="text-gray-500 mt-1">
							Administra la información de tus pacientes
						</p>
					</div>
					<button
						class="glass-button px-6 py-3 rounded-xl flex items-center gap-2 text-white bg-[#2F5D50] hover:bg-[#234D20] transition-all shadow-lg hover:shadow-[#2F5D50]/30 transform hover:-translate-y-1"
						onclick="abrirModal('modalFormulario', 'crear')"
					>
						<div
							class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center"
						>
							<i class="fa-solid fa-plus text-sm"></i>
						</div>
						<span class="font-semibold">Nuevo Paciente</span>
					</button>
				</div>

				{
					error && (
						<div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-xl shadow-sm animate-fade-in-up flex items-center gap-3">
							<i class="fa-solid fa-triangle-exclamation text-xl" />
							<div>
								<p class="font-bold">Error</p>
								<p>{error}</p>
							</div>
						</div>
					)
				}

				<!-- Tabla Container -->
				<div
					class="glass-panel rounded-3xl overflow-hidden animate-fade-in-up stagger-2 border border-white/40 shadow-xl"
				>
					<div class="overflow-x-auto custom-scrollbar">
						<table class="w-full text-left border-collapse">
							<thead>
								<tr
									class="bg-[#2F5D50]/5 text-[#2F5D50] border-b border-[#2F5D50]/10"
								>
									<th class="p-5 font-bold rounded-tl-2xl"
										>Paciente</th
									>
									<th
										class="p-5 font-bold hidden md:table-cell"
										>Contacto</th
									>
									<th
										class="p-5 font-bold hidden lg:table-cell"
										>Fecha Nac.</th
									>
									<th
										class="p-5 font-bold text-center w-32 rounded-tr-2xl"
										>Acciones</th
									>
								</tr>
							</thead>
							<tbody class="divide-y divide-[#2F5D50]/5">
								{
									pacientes.map((p) => (
										<tr class="hover:bg-white/60 transition-colors group paciente-row">
											<td class="p-5">
												<div class="flex items-center gap-4">
													<div class="h-12 w-12 rounded-full bg-gradient-to-br from-[#2F5D50] to-[#1a3c33] flex items-center justify-center text-white font-bold text-lg shrink-0 shadow-md group-hover:scale-110 transition-transform duration-300">
														{p.firstname}
													</div>
													<div>
														<div class="font-bold text-gray-800 text-lg">
															{p.firstname}{" "}
															{p.lastname}
														</div>
														<div class="text-sm text-gray-500 lg:hidden flex items-center gap-1 mt-1">
															<i class="fa-regular fa-envelope text-[#2F5D50]/60" />
															{p.email}
														</div>
													</div>
												</div>
											</td>
											<td class="p-5 hidden md:table-cell">
												<div class="flex flex-col gap-1">
													<span class="text-gray-700 font-medium flex items-center gap-2">
														<i class="fa-regular fa-envelope text-[#2F5D50]/60" />
														{p.email}
													</span>
													<span class="text-sm text-gray-500 flex items-center gap-2">
														<i class="fa-solid fa-phone text-[#2F5D50]/60" />
														{p.phone}
													</span>
												</div>
											</td>
											<td class="p-5 hidden lg:table-cell">
												<div class="text-gray-600 font-medium bg-white/50 px-3 py-1 rounded-lg border border-white/40 inline-flex items-center gap-2">
													<i class="fa-solid fa-cake-candles text-[#2F5D50]/60" />
													{new Date(
														p.birthday,
													).toLocaleDateString()}
												</div>
											</td>
											<td class="p-5 text-center">
												<div class="flex justify-center gap-2">
													<button
														class="w-9 h-9 rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 hover:scale-110 transition-all flex items-center justify-center shadow-sm"
														onclick={`prepararEdicion(${JSON.stringify(p)})`}
														title="Editar"
													>
														<i class="fa-solid fa-pen-to-square" />
													</button>
													<button
														class="w-9 h-9 rounded-xl bg-red-50 text-red-600 hover:bg-red-100 hover:scale-110 transition-all flex items-center justify-center shadow-sm"
														onclick={`confirmarEliminacion(${p.id}, '${p.firstname} ${p.lastname}')`}
														title="Eliminar"
													>
														<i class="fa-solid fa-trash" />
													</button>
												</div>
											</td>
										</tr>
									))
								}
								{
									pacientes.length === 0 && !error && (
										<tr>
											<td
												colspan="4"
												class="p-12 text-center text-gray-500"
											>
												<div class="flex flex-col items-center gap-4">
													<div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center">
														<i class="fa-solid fa-user-slash text-4xl text-gray-400" />
													</div>
													<p class="text-lg font-medium">
														No hay pacientes
														registrados
													</p>
													<button
														class="text-[#2F5D50] font-bold hover:underline"
														onclick="abrirModal('modalFormulario', 'crear')"
													>
														Crear el primer paciente
													</button>
												</div>
											</td>
										</tr>
									)
								}
							</tbody>
						</table>
					</div>

					<!-- Pagination -->
					<div
						class="p-4 border-t border-[#2F5D50]/10 flex justify-between items-center bg-white/30 backdrop-blur-sm"
					>
						<div class="text-sm text-gray-600 font-medium">
							Mostrando <span class="font-bold text-[#2F5D50]"
								>{pacientes.length}</span
							> registros
						</div>
						<div class="flex gap-2">
							<button
								class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:hover:bg-white/50 disabled:hover:text-[#2F5D50] shadow-sm"
								disabled
							>
								<i class="fa-solid fa-chevron-left"></i>
							</button>
							<button
								class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all shadow-sm"
							>
								<i class="fa-solid fa-chevron-right"></i>
							</button>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- Modal Formulario (Crear/Editar) -->
	<FormModal
		id="modalFormulario"
		title="Nuevo Paciente"
		formId="pacienteForm"
		submitText="Guardar"
		cancelText="Cancelar"
		size="lg"
	>
		<input type="hidden" id="pacienteId" name="id" />
		<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Nombre *</label
				>
				<input
					type="text"
					name="firstname"
					id="firstname"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
					placeholder="Ej. Juan"
				/>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Apellido Paterno *</label
				>
				<input
					type="text"
					name="lastname"
					id="lastname"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
					placeholder="Ej. Pérez"
				/>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Apellido Materno *</label
				>
				<input
					type="text"
					name="motherlastname"
					id="motherlastname"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
					placeholder="Ej. López"
				/>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Fecha de Nacimiento *</label
				>
				<input
					type="date"
					name="birthdate"
					id="birthdate"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
				/>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Teléfono *</label
				>
				<input
					type="tel"
					name="phone"
					id="phone"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
					placeholder="Ej. 55 1234 5678"
				/>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Email *</label
				>
				<input
					type="email"
					name="email"
					id="email"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
					placeholder="ejemplo@correo.com"
				/>
			</div>
			<div class="flex flex-col md:col-span-2">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Asignar Empleado</label
				>
				<div class="relative">
					<select
						id="employeeSelect"
						class="glass-input w-full rounded-xl px-4 py-2.5 appearance-none cursor-pointer focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					>
						<option value="">Seleccione un empleado...</option>
					</select>
					<div
						class="absolute right-4 top-1/2 -translate-y-1/2 text-[#2F5D50] pointer-events-none"
					>
						<i class="fa-solid fa-chevron-down text-xs"></i>
					</div>
				</div>
			</div>
		</div>
	</FormModal>

	<!-- Modal Confirmación Eliminación -->
	<div id="modalEliminar" class="fixed inset-0 z-50 hidden">
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
			onclick="cerrarModal('modalEliminar')"
		>
		</div>
		<div class="flex min-h-full items-center justify-center p-4">
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:w-full sm:max-w-md p-6 text-center"
			>
				<div
					class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100 mb-4"
				>
					<i
						class="fa-solid fa-triangle-exclamation text-3xl text-red-600"
					></i>
				</div>
				<h3 class="text-xl font-bold text-gray-900">
					Eliminar Paciente
				</h3>
				<p class="text-sm text-gray-500 mt-2">
					¿Estás seguro de que deseas eliminar a <span
						id="nombrePacienteEliminar"
						class="font-bold text-gray-800"></span>? Esta acción no
					se puede deshacer.
				</p>
				<div class="mt-6 flex gap-3">
					<button
						type="button"
						class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium transition-colors"
						onclick="cerrarModal('modalEliminar')">Cancelar</button
					>
					<button
						type="button"
						onclick="ejecutarEliminacion()"
						class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium shadow-lg shadow-red-600/30 transition-all transform hover:scale-105"
						>Eliminar</button
					>
				</div>
			</div>
		</div>
	</div>

	<script is:inline>
		// --- Lógica de Modales y CRUD ---
		let pacienteIdEliminar = null;

		window.abrirModal = async (id, modo) => {
			const modal = document.getElementById(id);
			if (!modal) return;

			modal.classList.remove("hidden");

			// Cargar empleados si es el formulario
			if (id === "modalFormulario") {
				await cargarEmpleados();

				const title = document.getElementById(
					"modal-title-modalFormulario",
				); // ID generado por FormModal
				const form = document.getElementById("pacienteForm");

				if (modo === "crear") {
					if (title) title.textContent = "Nuevo Paciente";
					form.reset();
					document.getElementById("pacienteId").value = "";
				}
			}
		};

		window.cerrarModal = (id) => {
			const modal = document.getElementById(id);
			if (modal) modal.classList.add("hidden");
		};

		window.prepararEdicion = async (paciente) => {
			await abrirModal("modalFormulario", "editar");
			const title = document.getElementById(
				"modal-title-modalFormulario",
			);
			if (title) title.textContent = "Editar Paciente";

			// Llenar formulario
			document.getElementById("pacienteId").value = paciente.id;
			document.getElementById("firstname").value = paciente.firstname;
			document.getElementById("lastname").value = paciente.lastname;
			document.getElementById("motherlastname").value =
				paciente.motherlastname;
			document.getElementById("birthdate").value =
				paciente.birthdate.split("T")[0];
			document.getElementById("phone").value = paciente.phone;
			document.getElementById("email").value = paciente.email;
		};

		window.confirmarEliminacion = (id, nombre) => {
			pacienteIdEliminar = id;
			document.getElementById("nombrePacienteEliminar").textContent =
				nombre;
			document.getElementById("modalEliminar").classList.remove("hidden");
		};

		// --- API Calls ---

		async function cargarEmpleados() {
			const select = document.getElementById("employeeSelect");
			if (select.children.length > 1) return; // Ya cargados

			try {
				const response = await fetch("/api/v1/Empleados"); // Corregido endpoint
				if (response.ok) {
					const data = await response.json();
					const empleados = Array.isArray(data)
						? data
						: data.body || [];

					empleados.forEach((emp) => {
						const option = document.createElement("option");
						option.value = emp.id;
						option.textContent = `${emp.firstname} ${emp.lastname}`;
						select.appendChild(option);
					});
				}
			} catch (error) {
				console.error("Error cargando empleados:", error);
			}
		}

		// Manejar envío del formulario
		document
			.getElementById("pacienteForm")
			?.addEventListener("submit", async (e) => {
				e.preventDefault();
				const form = e.target;
				const formData = new FormData(form);
				const id = formData.get("id");
				const isEdit = !!id;

				const data = {
					firstname: formData.get("firstname"),
					lastname: formData.get("lastname"),
					motherlastname: formData.get("motherlastname"),
					birthdate: formData.get("birthdate"),
					phone: formData.get("phone"),
					email: formData.get("email"),
					photo: "default.png", // Placeholder
					idEmpleado:
						document.getElementById("employeeSelect").value || 1, // Default o seleccionado
				};

				const url = isEdit
					? `/api/v1/Pacientes/${id}`
					: "/api/v1/Pacientes";

				const method = isEdit ? "PUT" : "POST";

				try {
					const response = await fetch(url, {
						method: method,
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(data),
					});

					if (response.ok) {
						alert(
							isEdit ? "Paciente actualizado" : "Paciente creado",
						);
						window.location.reload();
					} else {
						alert("Error al guardar");
					}
				} catch (error) {
					console.error("Error:", error);
					alert("Error de conexión");
				}
			});

		window.ejecutarEliminacion = async () => {
			if (!pacienteIdEliminar) return;

			try {
				const response = await fetch(
					`/api/v1/Pacientes/${pacienteIdEliminar}`,
					{
						method: "DELETE",
					},
				);

				if (response.ok) {
					alert("Paciente eliminado");
					window.location.reload();
				} else {
					alert("Error al eliminar");
				}
			} catch (error) {
				console.error("Error:", error);
				alert("Error de conexión");
			}
		};
	</script>
</Layout>
