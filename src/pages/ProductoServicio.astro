---
import Layout from "../layouts/Layout.astro";
import NavBar from "../components/NavBar.astro";
import TopTag from "../components/TopTag.astro";
import FormModal from "../components/modals/FormModal.astro";
import axios from "axios";

let table = [];
try {
	const response = await axios.get(
		"http://localhost:3001/api/v1/Productos&Servicios",
	);
	table = response.data;
} catch (error) {
	console.error("Error fetching data:", error);
	table = [];
}

// Función para escapar caracteres problemáticos en JavaScript
const escapeJS = (str) => {
	if (!str) return "";
	return String(str)
		.replace(/'/g, "\\'")
		.replace(/"/g, '\\"')
		.replace(/\n/g, "\\n")
		.replace(/\r/g, "\\r");
};
---

<Layout title="Productos y Servicios">
	<div
		class="flex h-screen overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
	>
		<NavBar />
		<div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
			<!-- Background Elements for depth -->
			<div
				class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
			>
			</div>
			<div
				class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
			>
			</div>

			<TopTag
				titulo="Gestión de Productos y Servicios"
				nombreUsuario="Administrador"
			/>

			<main
				class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
			>
				<!-- Header con título y botón agregar -->
				<div
					class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 animate-fade-in-up stagger-1"
				>
					<div>
						<h1
							class="text-3xl font-bold text-[#2F5D50] tracking-tight"
						>
							Lista de Productos y Servicios
						</h1>
						<p class="text-gray-500 mt-1">
							Administra el catálogo de servicios y productos
						</p>
					</div>
					<button
						class="glass-button px-6 py-3 rounded-xl flex items-center gap-2 text-white bg-[#2F5D50] hover:bg-[#234D20] transition-all shadow-lg hover:shadow-[#2F5D50]/30 transform hover:-translate-y-1"
						onclick="abrirModalAgregar()"
					>
						<div
							class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center"
						>
							<i class="fa-solid fa-plus text-sm"></i>
						</div>
						<span class="font-semibold">Agregar Nuevo</span>
					</button>
				</div>

				<!-- Tabla Container -->
				<div
					class="glass-panel rounded-3xl overflow-hidden animate-fade-in-up stagger-2 border border-white/40 shadow-xl"
				>
					<div class="overflow-x-auto custom-scrollbar">
						<table class="w-full text-left border-collapse">
							<thead>
								<tr
									class="bg-[#2F5D50]/5 text-[#2F5D50] border-b border-[#2F5D50]/10"
								>
									<th
										class="p-5 font-bold text-center w-16 rounded-tl-2xl"
										>Sel</th
									>
									<th class="p-5 font-bold">Nombre</th>
									<th class="p-5 font-bold">Precio</th>
									<th
										class="p-5 font-bold hidden md:table-cell"
										>Descripción</th
									>
									<th class="p-5 font-bold text-center"
										>Tipo</th
									>
									<th
										class="p-5 font-bold text-center w-32 rounded-tr-2xl"
										>Acciones</th
									>
								</tr>
							</thead>
							<tbody class="divide-y divide-[#2F5D50]/5">
								{
									table.map((item) => {
										const nombreEscaped = escapeJS(
											item.name,
										);
										const precioEscaped = escapeJS(
											item.value,
										);
										const descripcionEscaped = escapeJS(
											item.description,
										);
										const tipoEscaped = escapeJS(item.type);
										const nombreCompletoEscaped = escapeJS(
											item.name,
										);

										return (
											<tr class="hover:bg-white/60 transition-colors group">
												<td class="p-5 text-center">
													<div class="flex items-center justify-center">
														<input
															type="checkbox"
															class="producto-servicio-checkbox w-5 h-5 rounded-md border-gray-300 text-[#2F5D50] focus:ring-[#2F5D50] cursor-pointer"
															value={item.id}
														/>
													</div>
												</td>
												<td class="p-5">
													<div class="font-bold text-gray-800 text-lg">
														{item.name}
													</div>
												</td>
												<td class="p-5">
													<span class="font-bold text-[#2F5D50] bg-[#2F5D50]/10 px-3 py-1 rounded-lg">
														${item.value}
													</span>
												</td>
												<td class="p-5 hidden md:table-cell">
													<div class="text-gray-600 text-sm max-w-xs truncate bg-white/50 px-3 py-1 rounded-lg border border-white/40">
														{item.description}
													</div>
												</td>
												<td class="p-5 text-center">
													<span
														class={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-sm ${item.type === "service" ? "bg-blue-100 text-blue-700" : "bg-purple-100 text-purple-700"}`}
													>
														{item.type === "service"
															? "Servicio"
															: "Adicional"}
													</span>
												</td>
												<td class="p-5 text-center">
													<button
														class="w-8 h-8 rounded-full bg-white/50 hover:bg-[#2F5D50] hover:text-white text-[#2F5D50] transition-all shadow-sm flex items-center justify-center mx-auto"
														onclick={`abrirModalAcciones(${item.id}, '${nombreEscaped}', '${precioEscaped}', '${descripcionEscaped}', '${tipoEscaped}', '${nombreCompletoEscaped}')`}
														title="Acciones"
													>
														<i class="fa-solid fa-ellipsis-vertical" />
													</button>
												</td>
											</tr>
										);
									})
								}
							</tbody>
						</table>
					</div>

					<!-- Pagination -->
					<div
						class="p-4 border-t border-[#2F5D50]/10 flex justify-between items-center bg-white/30 backdrop-blur-sm"
					>
						<div class="text-sm text-gray-600 font-medium">
							Mostrando <span class="font-bold text-[#2F5D50]"
								>{table.length}</span
							> items
						</div>
						<div class="flex gap-2">
							<button
								class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:hover:bg-white/50 disabled:hover:text-[#2F5D50] shadow-sm"
								disabled
							>
								<i class="fa-solid fa-chevron-left"></i>
							</button>
							<button
								class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all shadow-sm"
							>
								<i class="fa-solid fa-chevron-right"></i>
							</button>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- Modal de Acciones -->
	<div
		id="modalAcciones"
		class="fixed inset-0 z-50 hidden"
		aria-labelledby="modal-title"
		role="dialog"
		aria-modal="true"
	>
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
			onclick="cerrarModal('modalAcciones')"
		>
		</div>
		<div
			class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
		>
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg p-6"
			>
				<div class="absolute right-4 top-4">
					<button
						type="button"
						class="text-gray-400 hover:text-gray-500"
						onclick="cerrarModal('modalAcciones')"
					>
						<i class="fa-solid fa-xmark text-xl"></i>
					</button>
				</div>

				<div class="text-center mb-6">
					<h3
						class="text-xl font-bold text-[#2F5D50]"
						id="modal-title"
					>
						Acciones
					</h3>
					<p class="text-sm text-gray-500 mt-2">
						Gestionar: <span
							id="nombreProductoServicioAcciones"
							class="font-bold text-[#2F5D50]"></span>
					</p>
				</div>

				<div class="grid grid-cols-2 gap-4">
					<button
						id="btnEditarAccion"
						class="flex flex-col items-center justify-center p-4 rounded-xl border border-[#2F5D50]/20 hover:bg-[#2F5D50]/5 transition-all group"
					>
						<div
							class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform"
						>
							<i class="fa-solid fa-pen-to-square text-xl"></i>
						</div>
						<span class="font-medium text-gray-700">Editar</span>
					</button>
					<button
						id="btnEliminarAccion"
						class="flex flex-col items-center justify-center p-4 rounded-xl border border-red-200 hover:bg-red-50 transition-all group"
					>
						<div
							class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform"
						>
							<i class="fa-solid fa-trash text-xl"></i>
						</div>
						<span class="font-medium text-gray-700">Eliminar</span>
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Confirmar Eliminar -->
	<div id="modalConfirmarEliminar" class="fixed inset-0 z-50 hidden">
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm"
			onclick="cerrarModal('modalConfirmarEliminar')"
		>
		</div>
		<div class="flex min-h-full items-center justify-center p-4">
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:w-full sm:max-w-md p-6"
			>
				<div class="text-center">
					<div
						class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100 mb-4"
					>
						<i
							class="fa-solid fa-triangle-exclamation text-3xl text-red-600"
						></i>
					</div>
					<h3 class="text-xl font-bold text-gray-900">
						¿Eliminar item?
					</h3>
					<p class="text-sm text-gray-500 mt-2">
						Estás a punto de eliminar <span
							id="nombreProductoServicioEliminar"
							class="font-bold text-gray-800"></span>. Esta acción
						no se puede deshacer.
					</p>
				</div>
				<div class="mt-6 flex gap-3">
					<button
						type="button"
						class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium"
						onclick="cerrarModal('modalConfirmarEliminar')"
						>Cancelar</button
					>
					<button
						type="button"
						id="btnConfirmarEliminar"
						class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium shadow-lg shadow-red-600/30"
						>Sí, Eliminar</button
					>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Agregar -->
	<FormModal
		id="modalAgregarProductoServicio"
		title="Nuevo Producto/Servicio"
		formId="formAgregarProductoServicio"
		submitText="Guardar"
		cancelText="Cancelar"
		size="lg"
	>
		<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<div class="flex flex-col">
				<label class="text-sm font-medium text-gray-700 mb-1"
					>Nombre *</label
				>
				<input
					type="text"
					id="agregarNombre"
					class="glass-input w-full rounded-lg px-4 py-2"
					required
					placeholder="Ej: Consulta General"
				/>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-medium text-gray-700 mb-1"
					>Precio *</label
				>
				<input
					type="number"
					id="agregarPrecio"
					class="glass-input w-full rounded-lg px-4 py-2"
					required
					placeholder="0.00"
					step="0.01"
					min="0"
				/>
			</div>
			<div class="flex flex-col md:col-span-2">
				<label class="text-sm font-medium text-gray-700 mb-1"
					>Descripción *</label
				>
				<textarea
					id="agregarDescripcion"
					class="glass-input w-full rounded-lg px-4 py-2"
					required
					rows="3"
					placeholder="Detalles del servicio..."></textarea>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-medium text-gray-700 mb-1"
					>Tipo *</label
				>
				<select
					id="agregarTipo"
					class="glass-input w-full rounded-lg px-4 py-2"
					required
				>
					<option value="">Seleccione...</option>
					<option value="service">Servicio</option>
					<option value="additional">Adicional</option>
				</select>
			</div>
		</div>
	</FormModal>

	<!-- Modal Editar -->
	<FormModal
		id="modalEditarProductoServicio"
		title="Editar Producto/Servicio"
		formId="formEditarProductoServicio"
		submitText="Actualizar"
		cancelText="Cancelar"
		size="lg"
	>
		<input type="hidden" id="editarId" />
		<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<div class="flex flex-col">
				<label class="text-sm font-medium text-gray-700 mb-1"
					>Nombre *</label
				>
				<input
					type="text"
					id="editarNombre"
					class="glass-input w-full rounded-lg px-4 py-2"
					required
				/>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-medium text-gray-700 mb-1"
					>Precio *</label
				>
				<input
					type="number"
					id="editarPrecio"
					class="glass-input w-full rounded-lg px-4 py-2"
					required
					step="0.01"
					min="0"
				/>
			</div>
			<div class="flex flex-col md:col-span-2">
				<label class="text-sm font-medium text-gray-700 mb-1"
					>Descripción *</label
				>
				<textarea
					id="editarDescripcion"
					class="glass-input w-full rounded-lg px-4 py-2"
					required
					rows="3"></textarea>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-medium text-gray-700 mb-1"
					>Tipo *</label
				>
				<select
					id="editarTipo"
					class="glass-input w-full rounded-lg px-4 py-2"
					required
				>
					<option value="service">Servicio</option>
					<option value="additional">Adicional</option>
				</select>
			</div>
		</div>
	</FormModal>

	<!-- Modal Exito/Error -->
	<div id="modalExito" class="fixed inset-0 z-[60] hidden">
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm"
			onclick="cerrarModal('modalExito')"
		>
		</div>
		<div class="flex min-h-full items-center justify-center p-4">
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:w-full sm:max-w-sm p-6 text-center"
			>
				<div
					class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100 mb-4"
				>
					<i class="fa-solid fa-check text-green-600 text-xl"></i>
				</div>
				<h3 class="text-lg font-bold text-gray-900 mb-2">¡Éxito!</h3>
				<p id="mensajeExito" class="text-sm text-gray-500 mb-4"></p>
				<button
					type="button"
					class="w-full px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 font-medium"
					onclick="cerrarModal('modalExito')">Aceptar</button
				>
			</div>
		</div>
	</div>

	<div id="modalError" class="fixed inset-0 z-[60] hidden">
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm"
			onclick="cerrarModal('modalError')"
		>
		</div>
		<div class="flex min-h-full items-center justify-center p-4">
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:w-full sm:max-w-sm p-6 text-center"
			>
				<div
					class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 mb-4"
				>
					<i class="fa-solid fa-xmark text-red-600 text-xl"></i>
				</div>
				<h3 class="text-lg font-bold text-gray-900 mb-2">Error</h3>
				<p id="mensajeError" class="text-sm text-gray-500 mb-4"></p>
				<button
					type="button"
					class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium"
					onclick="cerrarModal('modalError')">Aceptar</button
				>
			</div>
		</div>
	</div>

	<script>
		/**
		 * @typedef {Object} ProductoServicioData
		 * @property {string} [name]
		 * @property {number} [value]
		 * @property {string} [description]
		 * @property {string} [type]
		 * @property {string} [nombreCompleto]
		 */

		// Variables globales
		/** @type {number | null} */
		let productoServicioSeleccionado = null;
		/** @type {ProductoServicioData} */
		let productoServicioData = {};

		// Función para verificar checkbox seleccionado
		/**
		 * @param {string | number} id
		 * @returns {boolean}
		 */
		function verificarCheckboxSeleccionado(id) {
			const idNum = Number(id);
			if (isNaN(idNum)) return false;

			const checkbox = document.querySelector(
				`.producto-servicio-checkbox[value="${id}"]`,
			);
			if (!checkbox || !checkbox.checked) {
				mostrarError(
					"Por favor, seleccione el item marcando la casilla.",
				);
				return false;
			}
			return true;
		}

		// Abrir modal de acciones
		// Abrir modal de acciones
		window.abrirModalAcciones = function (
			id,
			name,
			value,
			description,
			type,
			nombreCompleto,
		) {
			if (!verificarCheckboxSeleccionado(id)) return;

			productoServicioSeleccionado = Number(id);
			productoServicioData = {
				name,
				value,
				description,
				type,
				nombreCompleto,
			};

			const nombreEl = document.getElementById(
				"nombreProductoServicioAcciones",
			);
			if (nombreEl) nombreEl.textContent = nombreCompleto;

			const modal = document.getElementById("modalAcciones");
			if (modal) modal.classList.remove("hidden");
		};

		// Abrir modal agregar
		window.abrirModalAgregar = function () {
			const form = document.getElementById("formAgregarProductoServicio");
			if (form) form.reset();
			const modal = document.getElementById(
				"modalAgregarProductoServicio",
			);
			if (modal) modal.classList.remove("hidden");
		};

		// Cerrar modales
		/**
		 * @param {string} modalId
		 */
		window.cerrarModal = function (modalId) {
			const modal = document.getElementById(modalId);
			if (modal) modal.classList.add("hidden");
		};

		// Mostrar mensajes
		function mostrarExito(mensaje: string) {
			const msgEl = document.getElementById("mensajeExito");
			if (msgEl) msgEl.textContent = mensaje;
			const modal = document.getElementById("modalExito");
			if (modal) modal.classList.remove("hidden");
		}

		function mostrarError(mensaje: string) {
			const msgEl = document.getElementById("mensajeError");
			if (msgEl) msgEl.textContent = mensaje;
			const modal = document.getElementById("modalError");
			if (modal) modal.classList.remove("hidden");
		}

		// Event Listeners
		document.addEventListener("DOMContentLoaded", function () {
			// Botones de acción
			document
				.getElementById("btnEditarAccion")
				?.addEventListener("click", function () {
					window.cerrarModal("modalAcciones");
					abrirModalEditar();
				});

			document
				.getElementById("btnEliminarAccion")
				?.addEventListener("click", function () {
					window.cerrarModal("modalAcciones");
					abrirModalConfirmarEliminar();
				});

			document
				.getElementById("btnConfirmarEliminar")
				?.addEventListener("click", function () {
					if (productoServicioSeleccionado !== null) {
						eliminarProductoServicio(productoServicioSeleccionado);
					}
				});
		});

		// Abrir modal de edición
		function abrirModalEditar() {
			if (!productoServicioSeleccionado) return;

			const editarId = document.getElementById("editarId");
			const editarNombre = document.getElementById("editarNombre");
			const editarPrecio = document.getElementById("editarPrecio");
			const editarDescripcion =
				document.getElementById("editarDescripcion");
			const editarTipo = document.getElementById("editarTipo");

			if (editarId) editarId.value = productoServicioSeleccionado;
			if (editarNombre)
				editarNombre.value = productoServicioData.name || "";
			if (editarPrecio)
				editarPrecio.value = productoServicioData.value || "";
			if (editarDescripcion)
				editarDescripcion.value =
					productoServicioData.description || "";
			if (editarTipo) editarTipo.value = productoServicioData.type || "";

			const modal = document.getElementById(
				"modalEditarProductoServicio",
			);
			if (modal) modal.classList.remove("hidden");
		}

		// Abrir modal de confirmación de eliminación
		function abrirModalConfirmarEliminar() {
			const nombreEl = document.getElementById(
				"nombreProductoServicioEliminar",
			);
			if (nombreEl)
				nombreEl.textContent =
					productoServicioData.nombreCompleto || "";

			const modal = document.getElementById("modalConfirmarEliminar");
			if (modal) modal.classList.remove("hidden");
		}

		// Función para eliminar
		/**
		 * @param {number} id
		 */
		async function eliminarProductoServicio(id) {
			try {
				const response = await fetch(
					`/api/v1/Productos&Servicios/${id}`,
					{
						method: "DELETE",
						headers: { "Content-Type": "application/json" },
					},
				);

				if (response.ok) {
					window.cerrarModal("modalConfirmarEliminar");
					mostrarExito("Eliminado correctamente");
					setTimeout(() => location.reload(), 1500);
				} else {
					const errorData = await response.json();
					mostrarError(
						"Error al eliminar: " +
							(errorData.message ||
								errorData.error ||
								"Desconocido"),
					);
				}
			} catch (error) {
				mostrarError("Error de conexión: " + error.message);
			}
		}

		// Manejar envío Agregar
		document
			.getElementById("formAgregarProductoServicio")
			?.addEventListener("submit", async function (e) {
				e.preventDefault();

				const nombreEl = document.getElementById("agregarNombre");
				const precioEl = document.getElementById("agregarPrecio");
				const descEl = document.getElementById("agregarDescripcion");
				const tipoEl = document.getElementById("agregarTipo");

				const data = {
					name: nombreEl?.value,
					value: parseFloat(precioEl?.value || "0"),
					description: descEl?.value,
					type: tipoEl?.value,
				};

				try {
					const response = await fetch(
						"/api/v1/Productos&Servicios",
						{
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(data),
						},
					);

					if (response.ok) {
						window.cerrarModal("modalAgregarProductoServicio");
						mostrarExito("Agregado correctamente");
						setTimeout(() => location.reload(), 1500);
					} else {
						const errorData = await response.json();
						mostrarError(
							"Error al agregar: " +
								(errorData.message ||
									errorData.error ||
									"Desconocido"),
						);
					}
				} catch (error: any) {
					mostrarError("Error de conexión: " + error.message);
				}
			});

		// Manejar envío Editar
		document
			.getElementById("formEditarProductoServicio")
			?.addEventListener("submit", async function (e) {
				e.preventDefault();

				const nombreEl = document.getElementById("editarNombre");
				const precioEl = document.getElementById("editarPrecio");
				const descEl = document.getElementById("editarDescripcion");
				const tipoEl = document.getElementById("editarTipo");

				const data = {
					name: nombreEl?.value,
					value: parseFloat(precioEl?.value || "0"),
					description: descEl?.value,
					type: tipoEl?.value,
				};

				try {
					const response = await fetch(
						`/api/v1/Productos&Servicios/${productoServicioSeleccionado}`,
						{
							method: "PATCH",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(data),
						},
					);

					if (response.ok) {
						window.cerrarModal("modalEditarProductoServicio");
						mostrarExito("Actualizado correctamente");
						setTimeout(() => location.reload(), 1500);
					} else {
						const errorData = await response.json();
						mostrarError(
							"Error al actualizar: " +
								(errorData.message ||
									errorData.error ||
									"Desconocido"),
						);
					}
				} catch (error: any) {
					mostrarError("Error de conexión: " + error.message);
				}
			});

		// Seleccionar todos los checkboxes
		document
			.getElementById("selectAll")
			?.addEventListener("change", function (e) {
				const target = e.target as HTMLInputElement;
				const checkboxes = document.querySelectorAll(
					".producto-servicio-checkbox",
				);
				checkboxes.forEach((checkbox) => {
					(checkbox as HTMLInputElement).checked = target.checked;
				});
			});
	</script>
</Layout>
