---
import Layout from "../layouts/Layout.astro";
import NavBar from "../components/NavBar.astro";
import TopTag from "../components/TopTag.astro";
import FormModal from "../components/modals/FormModal.astro";
import axios from "axios";

let table = [];
let error = "";

try {
	const response = await axios.get(
		"http://localhost:3001/api/v1/Productos&Servicios",
	);
	table = response.data;
} catch (e) {
	console.error("Error fetching data:", e);
	error = "Error al cargar los productos y servicios";
	table = [];
}
---

<Layout title="Productos y Servicios">
	<div
		class="flex h-[100dvh] overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
	>
		<NavBar />
		<div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
			<!-- Background Elements for depth -->
			<div
				class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
			>
			</div>
			<div
				class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
			>
			</div>

			<TopTag
				titulo="Gestión de Productos y Servicios"
				nombreUsuario="Administrador"
			>
				<button
					class="glass-button px-5 py-2.5 rounded-xl flex items-center gap-2 text-white bg-[#2F5D50] hover:bg-[#234D20] transition-all shadow-lg hover:shadow-[#2F5D50]/30 transform hover:-translate-y-1 group"
					onclick="abrirModal('modalFormulario', 'crear')"
				>
					<div
						class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors"
					>
						<i class="fa-solid fa-plus text-xs"></i>
					</div>
					<span class="font-semibold text-sm">Agregar Nuevo</span>
				</button>
			</TopTag>

			<main
				class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
			>
				{
					error && (
						<div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-xl shadow-sm animate-fade-in-up flex items-center gap-3">
							<i class="fa-solid fa-triangle-exclamation text-xl" />
							<div>
								<p class="font-bold">Error</p>
								<p>{error}</p>
							</div>
						</div>
					)
				}

				<!-- Tabla Container -->
				<div
					class="glass-panel rounded-3xl overflow-visible animate-fade-in-up stagger-2 border border-white/40 shadow-xl"
				>
					<div class="overflow-x-auto custom-scrollbar rounded-3xl">
						<table class="w-full text-left border-collapse">
							<thead>
								<tr
									class="bg-[#2F5D50]/5 text-[#2F5D50] border-b border-[#2F5D50]/10"
								>
									<th class="p-5 font-bold">Nombre</th>
									<th class="p-5 font-bold">Precio</th>
									<th
										class="p-5 font-bold hidden md:table-cell"
										>Descripción</th
									>
									<th class="p-5 font-bold text-center"
										>Tipo</th
									>
									<th
										class="p-5 font-bold text-center w-20 rounded-tr-2xl"
										>Acciones</th
									>
								</tr>
							</thead>
							<tbody class="divide-y divide-[#2F5D50]/5">
								{
									table.map((item) => (
										<tr
											class="hover:bg-white/60 transition-colors group cursor-pointer"
											onclick={`verDetalles(${item.id})`}
										>
											<td class="p-5">
												<div class="font-bold text-gray-800 text-lg">
													{item.name}
												</div>
											</td>
											<td class="p-5">
												<span class="font-bold text-[#2F5D50] bg-[#2F5D50]/10 px-3 py-1 rounded-lg">
													${item.value}
												</span>
											</td>
											<td class="p-5 hidden md:table-cell">
												<div class="text-gray-600 text-sm max-w-xs truncate bg-white/50 px-3 py-1 rounded-lg border border-white/40">
													{item.description}
												</div>
											</td>
											<td class="p-5 text-center">
												<span
													class={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-sm ${item.type === "service" ? "bg-blue-100 text-blue-700" : "bg-purple-100 text-purple-700"}`}
												>
													{item.type === "service"
														? "Servicio"
														: "Adicional"}
												</span>
											</td>
											<td class="p-5 text-center relative">
												<div class="dropdown relative inline-block text-left">
													<button
														type="button"
														class="w-8 h-8 rounded-lg hover:bg-[#2F5D50]/10 text-gray-500 hover:text-[#2F5D50] transition-colors flex items-center justify-center"
														onclick={`event.stopPropagation(); toggleDropdown('dropdown-${item.id}')`}
													>
														<i class="fa-solid fa-ellipsis-vertical" />
													</button>
													<div
														id={`dropdown-${item.id}`}
														class="dropdown-menu hidden absolute right-0 mt-2 w-48 rounded-xl bg-white shadow-xl border border-gray-100 z-50 animate-fade-in-up origin-top-right"
														onclick="event.stopPropagation()"
													>
														<div class="py-1">
															<button
																class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-[#2F5D50] flex items-center gap-2 transition-colors"
																onclick={`verDetalles(${item.id}); toggleDropdown('dropdown-${item.id}')`}
															>
																<i class="fa-regular fa-pen-to-square" />
																Editar
															</button>
															<button
																class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors"
																onclick={`confirmarEliminacion(${item.id}, '${item.name}'); toggleDropdown('dropdown-${item.id}')`}
															>
																<i class="fa-regular fa-trash-can" />
																Eliminar
															</button>
														</div>
													</div>
												</div>
											</td>
										</tr>
									))
								}
								{
									table.length === 0 && !error && (
										<tr>
											<td
												colspan="5"
												class="p-12 text-center text-gray-500"
											>
												<div class="flex flex-col items-center gap-4">
													<div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center">
														<i class="fa-solid fa-box-open text-4xl text-gray-400" />
													</div>
													<p class="text-lg font-medium">
														No hay productos o
														servicios registrados
													</p>
													<button
														class="text-[#2F5D50] font-bold hover:underline"
														onclick="abrirModal('modalFormulario', 'crear')"
													>
														Agregar el primero
													</button>
												</div>
											</td>
										</tr>
									)
								}
							</tbody>
						</table>
					</div>

					<!-- Pagination -->
					<div
						class="p-4 border-t border-[#2F5D50]/10 flex justify-between items-center bg-white/30 backdrop-blur-sm"
					>
						<div class="text-sm text-gray-600 font-medium">
							Mostrando <span class="font-bold text-[#2F5D50]"
								>{table.length}</span
							> items
						</div>
						<div class="flex gap-2">
							<button
								class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:hover:bg-white/50 disabled:hover:text-[#2F5D50] shadow-sm"
								disabled
							>
								<i class="fa-solid fa-chevron-left"></i>
							</button>
							<button
								class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all shadow-sm"
							>
								<i class="fa-solid fa-chevron-right"></i>
							</button>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- Modal Formulario (Crear/Editar) -->
	<FormModal
		id="modalFormulario"
		title="Nuevo Producto/Servicio"
		formId="formProductoServicio"
		submitText="Guardar"
		cancelText="Cancelar"
		size="lg"
	>
		<input type="hidden" id="itemId" name="id" />
		<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Nombre *</label
				>
				<input
					type="text"
					name="name"
					id="name"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
					placeholder="Ej: Consulta General"
				/>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Precio *</label
				>
				<input
					type="number"
					name="value"
					id="value"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
					placeholder="0.00"
					step="0.01"
					min="0"
				/>
			</div>
			<div class="flex flex-col md:col-span-2">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Descripción *</label
				>
				<textarea
					name="description"
					id="description"
					class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					required
					rows="3"
					placeholder="Detalles del servicio..."></textarea>
			</div>
			<div class="flex flex-col">
				<label class="text-sm font-bold text-gray-700 mb-1 ml-1"
					>Tipo *</label
				>
				<div class="relative">
					<select
						name="type"
						id="type"
						class="glass-input w-full rounded-xl px-4 py-2.5 appearance-none cursor-pointer focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
						required
					>
						<option value="">Seleccione...</option>
						<option value="service">Servicio</option>
						<option value="additional">Adicional</option>
					</select>
					<div
						class="absolute right-4 top-1/2 -translate-y-1/2 text-[#2F5D50] pointer-events-none"
					>
						<i class="fa-solid fa-chevron-down text-xs"></i>
					</div>
				</div>
			</div>
		</div>
	</FormModal>

	<!-- Modal Confirmación Eliminación -->
	<div id="modalEliminar" class="fixed inset-0 z-50 hidden">
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
			onclick="cerrarModal('modalEliminar')"
		>
		</div>
		<div class="flex min-h-full items-center justify-center p-4">
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:w-full sm:max-w-md p-6 text-center"
			>
				<div
					class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100 mb-4"
				>
					<i
						class="fa-solid fa-triangle-exclamation text-3xl text-red-600"
					></i>
				</div>
				<h3 class="text-xl font-bold text-gray-900">¿Eliminar item?</h3>
				<p class="text-sm text-gray-500 mt-2">
					Estás a punto de eliminar <span
						id="nombreItemEliminar"
						class="font-bold text-gray-800"></span>. Esta acción no
					se puede deshacer.
				</p>
				<div class="mt-6 flex gap-3">
					<button
						type="button"
						class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium transition-colors"
						onclick="cerrarModal('modalEliminar')">Cancelar</button
					>
					<button
						type="button"
						onclick="ejecutarEliminacion()"
						class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium shadow-lg shadow-red-600/30 transition-all transform hover:scale-105"
						>Sí, Eliminar</button
					>
				</div>
			</div>
		</div>
	</div>

	<script is:inline>
		let itemIdEliminar = null;

		window.abrirModal = (id, modo) => {
			const modal = document.getElementById(id);
			if (!modal) return;

			modal.classList.remove("hidden");
			// Animation
			const content = modal.querySelector(".modal-content-wrapper");
			if (content) {
				setTimeout(() => {
					content.classList.remove("scale-95", "opacity-0");
					content.classList.add("scale-100", "opacity-100");
				}, 10);
			}

			if (id === "modalFormulario") {
				const title = document.getElementById(
					"modal-title-modalFormulario",
				);
				const form = document.getElementById("formProductoServicio");

				if (modo === "crear") {
					if (title) title.textContent = "Nuevo Producto/Servicio";
					form.reset();
					document.getElementById("itemId").value = "";
				}
			}
		};

		window.cerrarModal = (id) => {
			const modal = document.getElementById(id);
			if (!modal) return;

			const content = modal.querySelector(".modal-content-wrapper");
			if (content) {
				content.classList.remove("scale-100", "opacity-100");
				content.classList.add("scale-95", "opacity-0");
				setTimeout(() => {
					modal.classList.add("hidden");
				}, 300);
			} else {
				modal.classList.add("hidden");
			}
		};

		window.verDetalles = async (id) => {
			try {
				const response = await fetch(
					`/api/v1/Productos&Servicios/${id}`,
				);
				if (!response.ok) throw new Error("Error fetching item");
				const data = await response.json();
				const item = Array.isArray(data) ? data[0] : data;

				await abrirModal("modalFormulario", "editar");
				const title = document.getElementById(
					"modal-title-modalFormulario",
				);
				if (title) title.textContent = "Editar Producto/Servicio";

				// Llenar formulario
				document.getElementById("itemId").value = item.id;
				document.getElementById("name").value = item.name;
				document.getElementById("value").value = item.value;
				document.getElementById("description").value = item.description;
				document.getElementById("type").value = item.type;
			} catch (error) {
				console.error("Error:", error);
				alert("Error al cargar los datos");
			}
		};

		window.confirmarEliminacion = (id, nombre) => {
			itemIdEliminar = id;
			document.getElementById("nombreItemEliminar").textContent = nombre;
			document.getElementById("modalEliminar").classList.remove("hidden");
		};

		// Dropdown logic
		window.toggleDropdown = (id) => {
			document.querySelectorAll(".dropdown-menu").forEach((menu) => {
				if (menu.id !== id) menu.classList.add("hidden");
			});
			const dropdown = document.getElementById(id);
			if (dropdown) dropdown.classList.toggle("hidden");
		};

		window.addEventListener("click", (e) => {
			if (!e.target.closest(".dropdown")) {
				document.querySelectorAll(".dropdown-menu").forEach((menu) => {
					menu.classList.add("hidden");
				});
			}
		});

		// Form Submit
		document
			.getElementById("formProductoServicio")
			?.addEventListener("submit", async (e) => {
				e.preventDefault();
				const form = e.target;
				const formData = new FormData(form);
				const id = formData.get("id");
				const isEdit = !!id;

				const data = {
					name: formData.get("name"),
					value: parseFloat(formData.get("value")),
					description: formData.get("description"),
					type: formData.get("type"),
				};

				const url = isEdit
					? `/api/v1/Productos&Servicios/${id}`
					: "/api/v1/Productos&Servicios";

				const method = isEdit ? "PATCH" : "POST";

				try {
					const response = await fetch(url, {
						method: method,
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(data),
					});

					if (response.ok) {
						alert(
							isEdit
								? "Actualizado correctamente"
								: "Creado correctamente",
						);
						window.location.reload();
					} else {
						const errorData = await response.json();
						alert(
							"Error: " +
								(errorData.message || "Error al guardar"),
						);
					}
				} catch (error) {
					console.error("Error:", error);
					alert("Error de conexión");
				}
			});

		window.ejecutarEliminacion = async () => {
			if (!itemIdEliminar) return;

			try {
				const response = await fetch(
					`/api/v1/Productos&Servicios/${itemIdEliminar}`,
					{
						method: "DELETE",
					},
				);

				if (response.ok) {
					alert("Eliminado correctamente");
					window.location.reload();
				} else {
					alert("Error al eliminar");
				}
			} catch (error) {
				console.error("Error:", error);
				alert("Error de conexión");
			}
		};
	</script>
</Layout>
