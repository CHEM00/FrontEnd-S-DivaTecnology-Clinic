---
export const prerender = false;
import NavBar from "../components/NavBar.astro";
import Layout from "../layouts/Layout.astro";
import TopTag from "../components/TopTag.astro";
import FormModal from "../components/modals/FormModal.astro";

// Carga inicial de datos para los selectores del modal
let pacientes: Paciente[] = [];
let empleados: Empleado[] = [];
let servicios: Servicio[] = [];

const backendUrl =
    import.meta.env.BACKEND_URL || "https://api.jesstherapy.cloud";
const token = Astro.cookies.get("auth_token")?.value;
const headers: HeadersInit = {
    "Content-Type": "application/json",
    ...(token && { Cookie: `auth_token=${token}` }),
};

const { Agent } = await import("node:https");
const agent = new Agent({ rejectUnauthorized: false });

// Helper para fetch con agente (bypass SSL)
const fetchWithAgent = async (url: string) => {
    // @ts-ignore - node-fetch types mismatch with native fetch regarding 'agent'
    return fetch(url, { headers, agent });
};

try {
    const [pacientesRes, empleadosRes, serviciosRes] = await Promise.all([
        fetchWithAgent(`${backendUrl}/api/v1/Pacientes`).then((res) =>
            res.ok ? res.json() : [],
        ),
        fetchWithAgent(`${backendUrl}/api/v1/Agenda/fisio`).then((res) =>
            res.ok ? res.json() : [],
        ),
        fetchWithAgent(`${backendUrl}/api/v1/Agenda/services`).then((res) =>
            res.ok ? res.json() : [],
        ),
    ]);

    pacientes = (pacientesRes as Paciente[]) || [];
    empleados = (empleadosRes as Empleado[]) || [];
    servicios = (serviciosRes as Servicio[]) || [];
} catch (error) {
    console.error("Error cargando datos iniciales:", error);
}
---

<Layout title="Agenda">
    <div
        class="flex h-screen overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
    >
        <NavBar />

        <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <!-- Background Elements -->
            <div
                class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
            >
            </div>
            <div
                class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
            >
            </div>

            <TopTag titulo="AGENDA" nombreUsuario="ADMINISTRADOR">
                <!-- Botón Nueva Cita en el Header para mejor visibilidad -->
                <button
                    id="nuevaCitaBtnHeader"
                    class="hidden md:flex glass-button px-4 py-2 rounded-xl bg-[#2F5D50] text-white hover:bg-[#234D20] transition-all font-medium items-center gap-2 shadow-lg hover:shadow-[#2F5D50]/30 transform hover:-translate-y-0.5 text-sm ml-4"
                >
                    <i class="fa-solid fa-plus"></i>
                    NUEVA CITA
                </button>
            </TopTag>

            <main
                class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10 flex flex-col"
            >
                <!-- Botón Flotante para Móvil -->
                <button
                    id="nuevaCitaBtnMobile"
                    class="md:hidden fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-[#2F5D50] text-white shadow-xl flex items-center justify-center text-2xl hover:scale-110 transition-transform"
                >
                    <i class="fa-solid fa-plus"></i>
                </button>

                <!-- Contenedor Principal: Calendario + Panel Lateral -->
                <div class="flex flex-col lg:flex-row gap-6 flex-1 min-h-0">
                    <!-- Calendario -->
                    <div
                        class="glass-panel rounded-3xl p-4 sm:p-6 flex-1 flex flex-col shadow-xl animate-fade-in-up stagger-2 overflow-hidden border border-white/60 relative"
                    >
                        <div
                            class="flex flex-col sm:flex-row justify-between items-center mb-4 sm:mb-6 gap-4"
                        >
                            <div
                                class="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-start"
                            >
                                <span
                                    class="text-xl sm:text-2xl font-bold text-[#2F5D50]"
                                    >Calendario</span
                                >
                                <!-- Botón Nueva Cita (visible en tablet/desktop si no cabe en header) -->
                                <button
                                    id="nuevaCitaBtn"
                                    class="md:hidden glass-button px-3 py-1.5 rounded-lg bg-[#2F5D50] text-white text-xs font-bold"
                                >
                                    + Cita
                                </button>
                            </div>
                            <div
                                class="flex items-center gap-2 sm:gap-4 bg-white/40 rounded-xl p-1 border border-white/50 shadow-inner w-full sm:w-auto justify-between sm:justify-center"
                            >
                                <button
                                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/80 text-[#2F5D50] transition-all"
                                    id="mesAnterior"
                                >
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>
                                <span
                                    class="text-base sm:text-lg font-bold text-[#2F5D50] min-w-[120px] sm:min-w-[150px] text-center capitalize"
                                    id="mesActual"
                                >
                                    <!-- Mes Actual -->
                                </span>
                                <button
                                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/80 text-[#2F5D50] transition-all"
                                    id="mesSiguiente"
                                >
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Contenedor con scroll horizontal para móvil -->
                        <div
                            class="flex-1 min-h-0 overflow-auto custom-scrollbar"
                        >
                            <div class="min-w-[600px] h-full flex flex-col">
                                <!-- Encabezado de días de la semana -->
                                <div class="grid grid-cols-7 mb-2">
                                    {
                                        [
                                            "DOM",
                                            "LUN",
                                            "MAR",
                                            "MIE",
                                            "JUE",
                                            "VIE",
                                            "SAB",
                                        ].map((dia) => (
                                            <div class="text-center py-2 text-xs sm:text-sm font-bold text-[#2F5D50]/70">
                                                {dia}
                                            </div>
                                        ))
                                    }
                                </div>

                                <!-- Grid de días del mes -->
                                <div
                                    class="grid grid-cols-7 grid-rows-6 gap-1 sm:gap-2 flex-1 min-h-0"
                                    id="daysGrid"
                                >
                                    <!-- Días se generarán dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Lateral (Detalles del Día / Cita) -->
                    <div
                        id="sidePanel"
                        class="hidden lg:flex flex-col w-full lg:w-96 glass-panel rounded-3xl shadow-xl border border-white/60 overflow-hidden transition-all duration-300 transform translate-x-full lg:translate-x-0 opacity-0 lg:opacity-100 absolute lg:relative inset-0 lg:inset-auto z-20 bg-white/95 lg:bg-transparent"
                        style="display: none;"
                    >
                        <!-- Header del Panel -->
                        <div
                            class="p-6 border-b border-[#2F5D50]/10 bg-white/40 flex justify-between items-center"
                        >
                            <h3
                                class="text-[#2F5D50] text-xl font-bold"
                                id="sidePanelTitle"
                            >
                                Detalles
                            </h3>
                            <button
                                id="closeSidePanelBtn"
                                class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-[#2F5D50] hover:bg-[#2F5D50]/10 transition-colors"
                            >
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>

                        <!-- Contenido del Panel -->
                        <div
                            id="sidePanelContent"
                            class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4"
                        >
                            <!-- Aquí se inyectarán las citas del día o el detalle de una cita -->
                            <div
                                class="flex flex-col items-center justify-center h-full text-gray-400 text-center"
                            >
                                <i class="fa-regular fa-calendar text-4xl mb-3"
                                ></i>
                                <p>Selecciona un día para ver las citas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Agregar Cita -->
    <FormModal
        id="modalAgregarCita"
        title="NUEVA CITA"
        formId="formAgregarCita"
        submitText="GUARDAR"
        cancelText="CANCELAR"
        size="lg"
    >
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1"
                        >PACIENTE *</label
                    >
                    <select
                        id="agregarIdPatient"
                        class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                        required
                    >
                        <option value="">Seleccionar paciente</option>
                        {
                            pacientes.map((paciente) => (
                                <option
                                    value={paciente.id}
                                    data-id-employed={paciente.idemployed}
                                >
                                    {paciente.firstname || "Sin Nombre"}{" "}
                                    {paciente.lastname || ""}
                                </option>
                            ))
                        }
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1"
                        >EMPLEADO *</label
                    >
                    <select
                        id="agregarIdEmployed"
                        class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                        required
                    >
                        <option value="">Seleccionar empleado</option>
                        {
                            empleados.map((empleado) => (
                                <option value={empleado.id}>
                                    {empleado.firstname} {empleado.lastname}
                                </option>
                            ))
                        }
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1"
                        >FECHA *</label
                    >
                    <div class="relative max-w-sm">
                        <div
                            class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"
                        >
                            <svg
                                class="w-4 h-4 text-gray-500"
                                aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"
                                ></path>
                            </svg>
                        </div>
                        <input
                            datepicker
                            datepicker-autohide
                            type="date"
                            id="agregarCurrentday"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5"
                            placeholder="Select date"
                        />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1"
                        >SERVICIO *</label
                    >
                    <select
                        id="agregarIdService"
                        class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                        required
                    >
                        <option value="">Seleccionar servicio</option>
                        {
                            servicios.map((servicio) => (
                                <option
                                    value={servicio.id}
                                    data-price={servicio.value || "0"}
                                >
                                    {servicio.name}
                                </option>
                            ))
                        }
                    </select>
                </div>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-sm font-bold text-gray-700 mb-1"
                            >HORA INICIO *</label
                        >
                        <select
                            id="agregarInitHour"
                            class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all cursor-pointer"
                            required
                            disabled
                        >
                            <option value="">Seleccionar fecha primero</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-sm font-bold text-gray-700 mb-1"
                            >HORA FIN</label
                        >
                        <input
                            type="text"
                            id="agregarEndHour"
                            class="glass-input w-full rounded-xl px-4 py-2.5 bg-gray-100 text-gray-500 cursor-not-allowed outline-none transition-all"
                            readonly
                            placeholder="--:--"
                        />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1"
                        >ESTADO *</label
                    >
                    <select
                        id="agregarStatus"
                        class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                        required
                    >
                        <option value="wait">En espera</option>
                        <option value="confirmed">Confirmada</option>
                        <option value="canceled">Cancelada</option>
                        <option value="concluded">Concluida</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1"
                        >RAZÓN/MOTIVO *</label
                    >
                    <input
                        type="text"
                        id="agregarReason"
                        class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                        required
                        placeholder="Motivo de la cita"
                    />
                </div>
            </div>
        </div>
    </FormModal>

    <!-- Scripts del Cliente -->
    <script>
        import { io } from "socket.io-client";

        // --- Estado Global ---
        let fechaActual = new Date();
        let citasDelMes: Cita[] = [];
        let citasPorDia: Record<string, Cita[]> = {};
        let socket: any;

        // --- Elementos del DOM ---
        const mesActualEl = document.getElementById("mesActual");
        const daysGridEl = document.getElementById("daysGrid");
        const sidePanelEl = document.getElementById("sidePanel");
        const sidePanelTitleEl = document.getElementById("sidePanelTitle");
        const sidePanelContentEl = document.getElementById("sidePanelContent");
        const closeSidePanelBtn = document.getElementById("closeSidePanelBtn");

        // --- Inicialización ---
        document.addEventListener("DOMContentLoaded", () => {
            // Inicializar Socket.io
            // En producción, si el backend está en otro dominio, usar la URL completa.
            // Si está proxied por Nginx en el mismo dominio, usar "/" o path relativo.
            // Asumimos que api.jesstherapy.cloud maneja los websockets.
            const socketUrl =
                import.meta.env.PUBLIC_BACKEND_URL ||
                "https://api.jesstherapy.cloud";
            socket = io(socketUrl);

            socket.on("connect", () => {
                console.log("Conectado al servidor de WebSocket");
            });

            socket.on("appointment_created", (newAppointment: Cita) => {
                console.log("Nueva cita recibida:", newAppointment);
                // Verificar si la cita pertenece al mes actual (opcional, pero buena práctica)
                // Por simplicidad, la agregamos y reprocesamos. Si no es de este mes, no se mostrará en el grid.
                citasDelMes.push(newAppointment);
                procesarCitas();

                // Si el panel lateral está abierto y es el día de la cita, actualizar lista
                actualizarPanelSiEsNecesario(newAppointment.currentday);
            });

            socket.on("appointment_updated", (updatedAppointment: Cita) => {
                console.log("Cita actualizada:", updatedAppointment);
                const index = citasDelMes.findIndex(
                    (c) =>
                        c.id === updatedAppointment.id ||
                        c.idappointment === updatedAppointment.id,
                );
                if (index !== -1) {
                    citasDelMes[index] = {
                        ...citasDelMes[index],
                        ...updatedAppointment,
                    };
                    procesarCitas();
                    actualizarPanelSiEsNecesario(updatedAppointment.currentday);
                }
            });

            socket.on("appointment_deleted", (deletedAppointment: Cita) => {
                console.log("Cita eliminada:", deletedAppointment);
                const index = citasDelMes.findIndex(
                    (c) =>
                        c.id === deletedAppointment.id ||
                        c.idappointment === deletedAppointment.id,
                );
                if (index !== -1) {
                    // Guardamos la fecha antes de eliminar para actualizar el panel
                    const fecha = citasDelMes[index].currentday;
                    citasDelMes.splice(index, 1);
                    procesarCitas();
                    actualizarPanelSiEsNecesario(fecha);
                }
            });

            renderCalendario();
            cargarCitasMes();

            // Event Listeners de Navegación
            document
                .getElementById("mesAnterior")
                ?.addEventListener("click", () => {
                    fechaActual.setMonth(fechaActual.getMonth() - 1);
                    renderCalendario();
                    cargarCitasMes();
                });

            document
                .getElementById("mesSiguiente")
                ?.addEventListener("click", () => {
                    fechaActual.setMonth(fechaActual.getMonth() + 1);
                    renderCalendario();
                    cargarCitasMes();
                });

            // Botones de Nueva Cita (Header, Mobile, Toolbar)
            const abrirModal = () => window.abrirModalAgregar();
            document
                .getElementById("nuevaCitaBtn")
                ?.addEventListener("click", abrirModal);
            document
                .getElementById("nuevaCitaBtnHeader")
                ?.addEventListener("click", abrirModal);
            document
                .getElementById("nuevaCitaBtnMobile")
                ?.addEventListener("click", abrirModal);

            closeSidePanelBtn?.addEventListener("click", () => {
                if (sidePanelEl) sidePanelEl.style.display = "none";
            });

            // Cargar empleados si no se cargaron desde el servidor
            cargarEmpleados();

            // --- Lógica de Nueva Cita ---
            const pacienteSelect = document.getElementById(
                "agregarIdPatient",
            ) as HTMLSelectElement;
            const empleadoSelect = document.getElementById(
                "agregarIdEmployed",
            ) as HTMLSelectElement;
            const fechaInput = document.getElementById(
                "agregarCurrentday",
            ) as HTMLInputElement;
            const horaInicioSelect = document.getElementById(
                "agregarInitHour",
            ) as HTMLSelectElement;
            const horaFinInput = document.getElementById(
                "agregarEndHour",
            ) as HTMLInputElement;

            // 1. Auto-seleccionar empleado al elegir paciente
            pacienteSelect?.addEventListener("change", (e) => {
                const target = e.target as HTMLSelectElement;
                const selectedOption = target.options[target.selectedIndex];
                const idEmployed =
                    selectedOption.getAttribute("data-id-employed");

                if (idEmployed && empleadoSelect) {
                    empleadoSelect.value = idEmployed;
                    // Disparar evento change manualmente para activar la búsqueda de horarios
                    empleadoSelect.dispatchEvent(new Event("change"));
                }
            });

            // 2. Buscar horarios disponibles
            async function buscarHorariosDisponibles() {
                const idEmployed = empleadoSelect?.value;
                const fecha = fechaInput?.value; // Formato esperado: YYYY-MM-DD o MM/DD/YYYY según datepicker

                if (!idEmployed || !fecha) {
                    if (horaInicioSelect) {
                        horaInicioSelect.innerHTML =
                            '<option value="">Seleccionar fecha y empleado</option>';
                        horaInicioSelect.disabled = true;
                    }
                    return;
                }

                // Asegurar formato de fecha YYYY-MM-DD
                let fechaFormateada = fecha;
                console.log("Fecha original:", fecha);

                if (fecha.includes("/")) {
                    const parts = fecha.split("/");
                    // Asumiendo DD/MM/YYYY
                    if (parts.length === 3)
                        fechaFormateada = `${parts[2]}-${parts[1]}-${parts[0]}`;
                } else if (fecha.includes("-")) {
                    const parts = fecha.split("-");
                    // Si es DD-MM-YYYY (año al final)
                    if (
                        parts.length === 3 &&
                        parts[0].length === 2 &&
                        parts[2].length === 4
                    ) {
                        fechaFormateada = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                }
                console.log("Fecha formateada para API:", fechaFormateada);

                try {
                    if (horaInicioSelect) {
                        horaInicioSelect.innerHTML =
                            '<option value="">Cargando...</option>';
                        horaInicioSelect.disabled = true;
                    }

                    const url = `/api/v1/Agenda/${idEmployed}/${fechaFormateada}`;
                    console.log("Consultando horarios:", url);

                    const res = await fetch(url);
                    if (res.ok) {
                        const horarios = await res.json();
                        console.log("Horarios disponibles:", horarios);

                        if (horaInicioSelect) {
                            horaInicioSelect.innerHTML =
                                '<option value="">Seleccionar hora</option>';

                            if (
                                Array.isArray(horarios) &&
                                horarios.length > 0
                            ) {
                                horarios.forEach((item: any) => {
                                    // La API devuelve objetos { "hora_disponible": "13:00:00" }
                                    const horaRaw = item.hora_disponible;
                                    if (horaRaw) {
                                        const hora = horaRaw.substring(0, 5); // "13:00"
                                        const option =
                                            document.createElement("option");
                                        option.value = hora;
                                        option.textContent = hora;
                                        horaInicioSelect.appendChild(option);
                                    }
                                });
                                horaInicioSelect.disabled = false;
                            } else {
                                horaInicioSelect.innerHTML =
                                    '<option value="">No hay horarios disponibles</option>';
                            }
                        }
                    } else {
                        console.error("Error al obtener horarios");
                        if (horaInicioSelect)
                            horaInicioSelect.innerHTML =
                                '<option value="">Error al cargar</option>';
                    }
                } catch (error) {
                    console.error("Error de red:", error);
                    if (horaInicioSelect)
                        horaInicioSelect.innerHTML =
                            '<option value="">Error de conexión</option>';
                }
            }

            empleadoSelect?.addEventListener(
                "change",
                buscarHorariosDisponibles,
            );
            // El datepicker puede disparar 'changeDate' o 'change' dependiendo de la librería.
            // Como es el nativo o flowbite, probamos con 'change' y 'blur'
            fechaInput?.addEventListener("change", buscarHorariosDisponibles);
            fechaInput?.addEventListener("blur", buscarHorariosDisponibles);

            // 3. Auto-calcular hora fin
            horaInicioSelect?.addEventListener("change", (e) => {
                const target = e.target as HTMLSelectElement;
                const horaInicio = target.value;
                if (horaInicio && horaFinInput) {
                    const [hours, minutes] = horaInicio.split(":").map(Number);
                    const fecha = new Date();
                    fecha.setHours(hours);
                    fecha.setMinutes(minutes);

                    // Sumar 1 hora (ajustar según requerimientos)
                    fecha.setHours(fecha.getHours() + 1);

                    const horaFin = `${String(fecha.getHours()).padStart(2, "0")}:${String(fecha.getMinutes()).padStart(2, "0")}`;
                    horaFinInput.value = horaFin;
                } else if (horaFinInput) {
                    horaFinInput.value = "";
                }
            });
        });

        async function cargarEmpleados() {
            const select = document.getElementById(
                "agregarIdEmployed",
            ) as HTMLSelectElement;
            if (!select || select.options.length > 1) return;

            try {
                const res = await fetch("/api/v1/Agenda/fisio");
                if (res.ok) {
                    const empleados = await res.json();
                    console.log("Datos de empleados recibidos:", empleados); // DEBUG: Ver estructura
                    empleados.forEach((emp: Empleado) => {
                        const option = document.createElement("option");
                        option.value = emp.id;
                        option.textContent = `${emp.firstname} ${emp.lastname}`;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error("Error cargando empleados:", e);
            }
        }

        // --- Helper de Fechas ---
        function getLocalYYYYMMDD(date: Date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        function getYYYYMMDDFromParts(
            year: number,
            monthIndex: number,
            day: number,
        ) {
            const m = String(monthIndex + 1).padStart(2, "0");
            const d = String(day).padStart(2, "0");
            return `${year}-${m}-${d}`;
        }

        // --- Funciones de Calendario ---
        function renderCalendario() {
            // Actualizar título del mes
            if (mesActualEl) {
                mesActualEl.textContent = fechaActual.toLocaleDateString(
                    "es-ES",
                    {
                        month: "long",
                        year: "numeric",
                    },
                );
            }

            if (!daysGridEl) return;
            daysGridEl.innerHTML = "";

            const year = fechaActual.getFullYear();
            const month = fechaActual.getMonth(); // 0-indexed

            const primerDiaMes = new Date(year, month, 1);
            const ultimoDiaMes = new Date(year, month + 1, 0);

            // Ajustar para que la semana empiece en Domingo (0)
            const diaInicioSemana = primerDiaMes.getDay();
            const totalDiasMes = ultimoDiaMes.getDate();

            // Rellenar días vacíos previos
            for (let i = 0; i < diaInicioSemana; i++) {
                const emptyDay = document.createElement("div");
                emptyDay.className = "bg-transparent";
                daysGridEl.appendChild(emptyDay);
            }

            // Crear días del mes
            for (let dia = 1; dia <= totalDiasMes; dia++) {
                // Construir string YYYY-MM-DD manualmente para evitar problemas de timezone
                const fechaStr = getYYYYMMDDFromParts(year, month, dia);

                // Para comprobar "hoy", usamos la fecha local
                const hoyStr = getLocalYYYYMMDD(new Date());
                const esHoy = hoyStr === fechaStr;

                const dayEl = document.createElement("div");
                dayEl.className = `
                    relative p-1 sm:p-2 rounded-xl border border-white/40 transition-all min-h-[60px] sm:min-h-[80px] flex flex-col gap-1 cursor-pointer hover:bg-white/60
                    ${esHoy ? "ring-2 ring-[#2F5D50] bg-white/50" : "bg-white/30"}
                `;
                dayEl.dataset.date = fechaStr;

                // Número del día
                dayEl.innerHTML = `
                    <div class="text-right font-bold text-xs sm:text-sm ${esHoy ? "text-[#2F5D50]" : "text-gray-600"}">
                        ${dia}
                    </div>
                    <div class="flex-1 flex flex-col justify-center items-center gap-1 overflow-hidden" id="citas-${fechaStr}">
                        <!-- Indicadores de citas se inyectarán aquí -->
                    </div>
                `;

                dayEl.addEventListener("click", () =>
                    seleccionarDia(fechaStr, dia),
                );
                if (daysGridEl) daysGridEl.appendChild(dayEl);
            }
        }

        async function cargarCitasMes() {
            const year = fechaActual.getFullYear();
            const month = fechaActual.getMonth();

            // Calcular rango de fechas para la API
            // startDate: Primer día del mes
            const startDate = getYYYYMMDDFromParts(year, month, 1);
            // endDate: Último día del mes
            const ultimoDia = new Date(year, month + 1, 0).getDate();
            const endDate = getYYYYMMDDFromParts(year, month, ultimoDia);

            console.log(
                `Solicitando citas desde ${startDate} hasta ${endDate}`,
            );

            try {
                // Usar ruta relativa para que pase por el proxy de Astro
                const response = await fetch(
                    `/api/v1/Agenda?startDate=${startDate}&endDate=${endDate}`,
                );
                if (response.ok) {
                    citasDelMes = await response.json();
                    console.log("Citas recibidas:", citasDelMes); // Debug
                    procesarCitas();
                } else {
                    console.error(
                        "Error al cargar citas del mes:",
                        response.status,
                    );
                }
            } catch (error) {
                console.error("Error de red:", error);
            }
        }

        function procesarCitas() {
            citasPorDia = {}; // Reiniciar agrupación

            if (!Array.isArray(citasDelMes)) {
                console.error("Formato de respuesta inesperado:", citasDelMes);
                return;
            }

            citasDelMes.forEach((cita: Cita) => {
                // Asumimos que currentday viene como "YYYY-MM-DD..."
                // Tomamos los primeros 10 caracteres para obtener la fecha
                if (cita.currentday) {
                    const fechaStr = cita.currentday.substring(0, 10);

                    if (!citasPorDia[fechaStr]) {
                        citasPorDia[fechaStr] = [];
                    }
                    citasPorDia[fechaStr].push(cita);
                } else {
                    console.warn("Cita sin fecha:", cita);
                }
            });

            console.log("Citas procesadas por día:", citasPorDia);
            actualizarIndicadoresCalendario();
        }

        function actualizarIndicadoresCalendario() {
            Object.keys(citasPorDia).forEach((fechaStr) => {
                const container = document.getElementById(`citas-${fechaStr}`);
                if (container) {
                    container.innerHTML = ""; // Limpiar
                    const citas = citasPorDia[fechaStr];

                    // Mostrar TAG con contador de citas
                    if (citas.length > 0) {
                        const badge = document.createElement("div");
                        badge.className =
                            "bg-[#2F5D50] text-white text-[10px] sm:text-xs font-bold px-2 py-0.5 rounded-full shadow-sm animate-fade-in";
                        badge.textContent = `${citas.length} Citas`;
                        container.appendChild(badge);
                    }
                }
            });
        }

        function actualizarPanelSiEsNecesario(fechaISO: string) {
            if (!fechaISO) return;
            const fechaStr = fechaISO.substring(0, 10);

            // Verificar si el panel está visible
            if (sidePanelEl && sidePanelEl.style.display !== "none") {
                // @ts-ignore
                if (window.fechaSeleccionada === fechaStr) {
                    const citas = citasPorDia[fechaStr] || [];
                    renderListaCitasDia(citas);
                }
            }
        }

        // --- Lógica del Panel Lateral ---
        function seleccionarDia(fechaStr: string, diaNumero: number) {
            // Guardar fecha seleccionada para actualizaciones en tiempo real
            // @ts-ignore
            window.fechaSeleccionada = fechaStr;

            if (sidePanelEl) {
                // Mostrar panel
                sidePanelEl.style.display = "flex";
                // Pequeño timeout para permitir la transición de opacidad
                setTimeout(() => {
                    sidePanelEl.classList.remove(
                        "translate-x-full",
                        "opacity-0",
                    );
                }, 10);
            }

            // Formatear fecha para título
            const [year, month, day] = fechaStr.split("-");
            const dateObj = new Date(
                parseInt(year),
                parseInt(month) - 1,
                parseInt(day),
            );

            if (sidePanelTitleEl) {
                sidePanelTitleEl.textContent = `Citas del ${dateObj.toLocaleDateString("es-ES", { day: "numeric", month: "long" })}`;
            }

            const citas = citasPorDia[fechaStr] || [];
            console.log(`Mostrando citas para ${fechaStr}:`, citas);
            renderListaCitasDia(citas);
        }

        function renderListaCitasDia(citas: Cita[]) {
            if (!sidePanelContentEl) return;
            sidePanelContentEl.innerHTML = "";

            if (citas.length === 0) {
                sidePanelContentEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                        <i class="fa-regular fa-calendar-xmark text-3xl mb-2"></i>
                        <p>No hay citas programadas</p>
                        <button onclick="window.abrirModalAgregar()" class="mt-4 text-[#2F5D50] font-bold text-sm hover:underline">
                            + Agregar Cita
                        </button>
                    </div>
                `;
                return;
            }

            citas.forEach((cita) => {
                const card = document.createElement("div");
                card.className =
                    "glass-panel p-4 rounded-xl cursor-pointer hover:bg-white/60 transition-all border border-white/50 shadow-sm group mb-3";

                const statusColorText =
                    cita.status === "confirmed"
                        ? "text-blue-600"
                        : cita.status === "concluded"
                          ? "text-green-600"
                          : cita.status === "canceled"
                            ? "text-red-600"
                            : "text-yellow-600";

                const statusBg =
                    cita.status === "confirmed"
                        ? "bg-blue-100"
                        : cita.status === "concluded"
                          ? "bg-green-100"
                          : cita.status === "canceled"
                            ? "bg-red-100"
                            : "bg-yellow-100";

                const initHour = cita.inithour
                    ? cita.inithour.substring(0, 5)
                    : "--:--";
                const endHour = cita.endhour
                    ? cita.endhour.substring(0, 5)
                    : "--:--";

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-[#2F5D50] text-sm bg-[#2F5D50]/10 px-2 py-0.5 rounded">
                            ${initHour} - ${endHour}
                        </span>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ${statusBg} ${statusColorText}">
                            ${cita.status}
                        </span>
                    </div>
                    <h4 class="font-bold text-gray-800 text-base mb-1">${cita.patient_firstname || "Paciente"} ${cita.patient_lastname || ""}</h4>
                    <p class="text-xs text-gray-500 line-clamp-2">${cita.reason || "Sin motivo"}</p>
                `;

                card.addEventListener("click", () =>
                    cargarDetalleCita(cita.id || cita.idappointment || 0),
                );
                sidePanelContentEl.appendChild(card);
            });
        }

        async function cargarDetalleCita(id: number) {
            if (!sidePanelContentEl) return;
            sidePanelContentEl.innerHTML = `
                <div class="flex justify-center items-center h-40">
                    <i class="fa-solid fa-spinner fa-spin text-2xl text-[#2F5D50]"></i>
                </div>
            `;
            if (sidePanelTitleEl)
                sidePanelTitleEl.textContent = "Detalle de Cita";

            try {
                const response = await fetch(`/api/v1/Agenda/${id}`);
                if (response.ok) {
                    const data = await response.json();
                    if (
                        data &&
                        data.length > 0 &&
                        data[0].get_appointment_detail
                    ) {
                        renderDetalleCita(data[0].get_appointment_detail);
                    } else {
                        sidePanelContentEl.innerHTML =
                            "<p class='text-center text-red-500'>No se encontraron detalles</p>";
                    }
                } else {
                    throw new Error("Error al obtener detalles");
                }
            } catch (error) {
                console.error(error);
                sidePanelContentEl.innerHTML =
                    "<p class='text-center text-red-500'>Error al cargar detalles</p>";
            }
        }

        function renderDetalleCita(detalle: any) {
            const { appointment, patient, employed, notes } = detalle;

            if (!sidePanelContentEl) return;

            // Botón volver
            const backBtn = document.createElement("button");
            backBtn.className =
                "mb-4 text-sm text-[#2F5D50] font-bold flex items-center gap-2 hover:underline";
            backBtn.innerHTML =
                '<i class="fa-solid fa-arrow-left"></i> Volver a la lista';
            backBtn.onclick = () => {
                const fechaStr = appointment.currentday.split("T")[0];
                const [y, m, d] = fechaStr.split("-");
                seleccionarDia(fechaStr, parseInt(d));
            };

            sidePanelContentEl.innerHTML = "";
            sidePanelContentEl.appendChild(backBtn);

            const initHour = appointment.inithour
                ? appointment.inithour.substring(0, 5)
                : "--:--";
            const endHour = appointment.endhour
                ? appointment.endhour.substring(0, 5)
                : "--:--";

            const content = `
                <div class="space-y-6 animate-fade-in">
                    <!-- Header Paciente -->
                    <div class="text-center">
                        <div class="w-20 h-20 rounded-full bg-[#2F5D50]/10 mx-auto flex items-center justify-center text-[#2F5D50] text-3xl mb-3 overflow-hidden shadow-inner">
                            ${patient.photo ? `<img src="${patient.photo}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user"></i>'}
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">${patient.firstname} ${patient.lastname}</h3>
                        <p class="text-sm text-gray-500">Paciente</p>
                    </div>

                    <!-- Info Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="glass-panel p-3 rounded-xl text-center bg-white/40">
                            <i class="fa-regular fa-clock text-[#2F5D50] mb-1"></i>
                            <p class="text-xs text-gray-500">Horario</p>
                            <p class="font-bold text-sm text-gray-800">${initHour} - ${endHour}</p>
                        </div>
                        <div class="glass-panel p-3 rounded-xl text-center bg-white/40">
                            <i class="fa-solid fa-info-circle text-[#2F5D50] mb-1"></i>
                            <p class="text-xs text-gray-500">Estado</p>
                            <p class="font-bold text-sm capitalize text-gray-800">${appointment.status}</p>
                        </div>
                    </div>

                    <!-- Detalles -->
                    <div class="space-y-4">
                        <div class="bg-white/40 p-4 rounded-xl border border-white/50">
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Motivo</h4>
                            <p class="text-gray-800 font-medium">${appointment.reason}</p>
                        </div>

                        <div class="bg-white/40 p-4 rounded-xl border border-white/50">
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Especialista</h4>
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-[#2F5D50]/20 flex items-center justify-center text-[#2F5D50]">
                                    <i class="fa-solid fa-user-doctor text-sm"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-sm text-gray-800">${employed.firstname} ${employed.lastname}</p>
                                    <p class="text-xs text-gray-500">ID: ${employed.id}</p>
                                </div>
                            </div>
                        </div>

                        ${
                            notes
                                ? `
                        <div class="bg-yellow-50/80 p-4 rounded-xl border border-yellow-100">
                            <h4 class="text-xs font-bold text-yellow-700 uppercase mb-2"><i class="fa-regular fa-note-sticky mr-1"></i> Nota Terapéutica</h4>
                            <p class="text-sm text-gray-700 italic">"${notes.therapeuticnote}"</p>
                            ${notes.diagnostic ? `<p class="text-sm text-gray-700 mt-2 font-bold">Dx: ${notes.diagnostic}</p>` : ""}
                        </div>
                        `
                                : ""
                        }
                    </div>
                </div>
            `;

            const contentDiv = document.createElement("div");
            contentDiv.innerHTML = content;
            sidePanelContentEl.appendChild(contentDiv);
        }

        document
            .getElementById("formAgregarCita")
            ?.addEventListener("submit", async (e) => {
                e.preventDefault();

                const idPatientEl = document.getElementById(
                    "agregarIdPatient",
                ) as HTMLSelectElement;
                const idEmployedEl = document.getElementById(
                    "agregarIdEmployed",
                ) as HTMLSelectElement;
                const currentDayEl = document.getElementById(
                    "agregarCurrentday",
                ) as HTMLInputElement;
                const initHourEl = document.getElementById(
                    "agregarInitHour",
                ) as HTMLSelectElement;
                const endHourEl = document.getElementById(
                    "agregarEndHour",
                ) as HTMLSelectElement;
                const statusEl = document.getElementById(
                    "agregarStatus",
                ) as HTMLSelectElement;
                const reasonEl = document.getElementById(
                    "agregarReason",
                ) as HTMLInputElement;

                if (
                    !idPatientEl ||
                    !idEmployedEl ||
                    !currentDayEl ||
                    !initHourEl ||
                    !endHourEl
                ) {
                    alert(
                        "Error interno: Elementos del formulario no encontrados",
                    );
                    return;
                }

                const serviceSelect = document.getElementById(
                    "agregarIdService",
                ) as HTMLSelectElement;
                const selectedServiceOption =
                    serviceSelect?.options[serviceSelect.selectedIndex];
                const serviceId = serviceSelect?.value;
                const servicePrice =
                    selectedServiceOption?.getAttribute("data-price");

                const data = {
                    idpatient: idPatientEl.value.toString(),
                    idemployed: idEmployedEl.value.toString(),
                    // idservice ya no va aquí
                    currentday: currentDayEl.value, // YYYY-MM-DD
                    inithour: initHourEl.value,
                    endhour: endHourEl.value,
                    status: statusEl?.value || "wait",
                    reason: reasonEl?.value || "",
                    photo: null,
                    idpatientpackage: null,
                };

                // Validar que se hayan seleccionado horas y servicio
                if (!data.inithour || !data.endhour) {
                    alert("Por favor seleccione hora de inicio y fin");
                    return;
                }

                if (!serviceId) {
                    alert("Por favor seleccione un servicio");
                    return;
                }

                try {
                    // 1. Crear la Cita
                    const response = await fetch("/api/v1/Citas", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log("Respuesta crear cita:", result);

                        // Obtener ID de la cita creada.
                        let idCita = null;
                        if (result && result.id) {
                            idCita = result.id;
                        } else if (result && result.insertId) {
                            idCita = result.insertId;
                        } else if (result && result.data && result.data.id) {
                            idCita = result.data.id;
                        } else if (
                            Array.isArray(result) &&
                            result.length > 0 &&
                            result[0].id
                        ) {
                            idCita = result[0].id;
                        }

                        console.log("ID Cita capturado:", idCita);

                        if (idCita) {
                            // 2. Asignar Servicio
                            const serviceData = {
                                serviceId: serviceId,
                                amount: "1",
                                unit_price: servicePrice || "0.00",
                            };

                            const serviceResponse = await fetch(
                                `/api/v1/Agenda/${idCita}/services`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(serviceData),
                                },
                            );

                            if (serviceResponse.ok) {
                                console.log("Servicio asignado correctamente");
                            } else {
                                console.error("Error al asignar servicio");
                                alert(
                                    "Cita creada, pero hubo un error al asignar el servicio.",
                                );
                            }
                        } else {
                            console.warn(
                                "No se pudo obtener el ID de la cita para asignar el servicio",
                            );
                        }

                        window.cerrarModal("modalAgregarCita");

                        // Limpiar formulario
                        (
                            document.getElementById(
                                "formAgregarCita",
                            ) as HTMLFormElement
                        )?.reset();

                        // Limpiar campos dinámicos y deshabilitar select de hora
                        if (initHourEl) {
                            initHourEl.innerHTML =
                                '<option value="">Seleccionar fecha primero</option>';
                            initHourEl.disabled = true;
                        }
                        if (endHourEl) {
                            endHourEl.value = "";
                        }

                        // Recargar citas del mes para mostrar la nueva
                        cargarCitasMes();
                        alert("Cita creada exitosamente");
                    } else {
                        alert("Error al crear la cita");
                    }
                } catch (error) {
                    console.error(error);
                    alert("Error de conexión");
                }
            });

        // Exponer funciones globales para el modal
        window.abrirModalAgregar = () => {
            const modal = document.getElementById("modalAgregarCita");
            if (modal) {
                modal.classList.remove("hidden");
                // Animar entrada
                const content = modal.querySelector(".modal-content-wrapper");
                if (content) {
                    setTimeout(() => {
                        content.classList.remove("scale-95", "opacity-0");
                        content.classList.add("scale-100", "opacity-100");
                    }, 10);
                }
            }
        };

        window.cerrarModal = (id: string) => {
            const modal = document.getElementById(id);
            if (modal) {
                const content = modal.querySelector(".modal-content-wrapper");
                if (content) {
                    content.classList.remove("scale-100", "opacity-100");
                    content.classList.add("scale-95", "opacity-0");

                    // Esperar a que termine la transición antes de ocultar
                    setTimeout(() => {
                        modal.classList.add("hidden");
                    }, 300);
                } else {
                    modal.classList.add("hidden");
                }
            }
        };
    </script>
</Layout>
