---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import NavBar from "../components/NavBar.astro";
import TopTag from "../components/TopTag.astro";
import FormModal from "../components/modals/FormModal.astro";
const today = new Date().toISOString().split("T")[0];
const backendUrl =
	import.meta.env.BACKEND_URL || "https://api.jesstherapy.cloud";
const token = Astro.cookies.get("auth_token")?.value;

const headers = {
	"Content-Type": "application/json",
	...(token && { Cookie: `auth_token=${token}` }),
};

// We need to use a custom agent for self-signed certs if needed, similar to the proxy
// But native fetch in Node 18 might need 'rejectUnauthorized: false' via an agent if the backend is https self-signed
// However, for simplicity, let's try standard fetch first. If it fails with SSL error, we'll add the agent.
// Actually, since we had to add the agent in the proxy, we probably need it here too if the backend is the same.

const { Agent } = await import("node:https");
const agent = new Agent({ rejectUnauthorized: false });

let benefit = [];
let appointmentStatus = [{ citas: {} }];

try {
	const resBenefit = await fetch(
		`${backendUrl}/api/v1/Benefit?date=${today}`,
		{ headers, agent },
	);
	if (resBenefit.ok) {
		benefit = await resBenefit.json();
	}
} catch (e) {
	console.error("Error fetching Benefit:", e);
}

try {
	const resStatus = await fetch(
		`${backendUrl}/api/v1/AppointmentStatus?date=${today}`,
		{ headers, agent },
	);
	if (resStatus.ok) {
		appointmentStatus = await resStatus.json();
	}
} catch (e) {
	console.error("Error fetching AppointmentStatus:", e);
}
---

<Layout title="Dashboard Administrador">
	<div
		class="flex h-[100dvh] overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
	>
		<NavBar />
		<div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
			<!-- Background Elements for depth -->
			<div
				class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
			>
			</div>
			<div
				class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
			>
			</div>

			<TopTag
				titulo="Dashboard Administrador"
				nombreUsuario="Administrador"
			/>

			<main
				class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
			>
				<!-- Grid Principal con mayor separación -->
				<div
					class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:h-full h-auto"
				>
					<!-- Columna Izquierda: Gráficos y Estadísticas (8 columnas) -->
					<div class="lg:col-span-8 flex flex-col gap-8">
						<!-- Fila Superior: Gráfico Principal -->
						<div
							class="glass-panel rounded-3xl p-8 h-[400px] lg:h-[32rem] flex flex-col relative overflow-hidden group hover:shadow-2xl transition-all duration-500 border border-white/60 !bg-white shadow-sm"
						>
							<div
								class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 z-10 gap-4 sm:gap-0 flex-shrink-0"
							>
								<div>
									<h2
										class="text-2xl font-bold text-[#2F5D50] tracking-tight flex items-center gap-3"
									>
										<div
											class="w-10 h-10 rounded-xl bg-[#2F5D50]/10 flex items-center justify-center"
										>
											<i
												class="fa-solid fa-chart-column text-[#2F5D50]"
											></i>
										</div>
										Venta de Adicionales
									</h2>
									<p class="text-sm text-gray-500 mt-1 ml-14">
										Rendimiento del equipo en tiempo real
									</p>
								</div>
								<div class="relative z-20">
									<div class="flex gap-2">
										<div class="relative group">
											<input
												type="date"
												id="chart-date-start"
												class="glass-input rounded-xl px-4 py-2 text-sm font-bold text-[#2F5D50] outline-none focus:ring-2 focus:ring-[#2F5D50]/20 bg-white/50 w-36"
												title="Fecha Inicio"
											/>
											<div
												class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-[#2F5D50]"
											>
												<i
													class="fa-regular fa-calendar"
												></i>
											</div>
										</div>
										<div class="relative group">
											<input
												type="date"
												id="chart-date-end"
												class="glass-input rounded-xl px-4 py-2 text-sm font-bold text-[#2F5D50] outline-none focus:ring-2 focus:ring-[#2F5D50]/20 bg-white/50 w-36"
												title="Fecha Fin (Opcional)"
											/>
											<div
												class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-[#2F5D50]"
											>
												<i
													class="fa-regular fa-calendar"
												></i>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div
								class="w-full flex-grow overflow-x-auto overflow-y-hidden z-10 min-h-0"
							>
								<div
									id="columnchart_material"
									class="w-full h-full min-w-[300px]"
								>
								</div>
							</div>
						</div>

						<!-- Fila Inferior: KPIs -->
						<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
							<!-- Ingresos Card -->
							<div
								class="glass-panel rounded-3xl p-8 flex flex-col justify-between relative overflow-hidden group hover:-translate-y-2 transition-all duration-300 border border-white/60 !bg-white shadow-lg hover:shadow-2xl min-h-[18rem]"
							>
								<div
									class="absolute top-0 right-0 p-8 opacity-10 group-hover:opacity-20 transition-all duration-500 transform group-hover:scale-110 group-hover:rotate-12"
								>
									<i
										class="fa-solid fa-sack-dollar text-8xl text-[#2F5D50]"
									></i>
								</div>

								<div class="z-10">
									<div
										class="flex justify-between items-start mb-3"
									>
										<div class="flex items-center gap-4">
											<div
												class="w-12 h-12 rounded-2xl bg-[#2F5D50]/10 flex items-center justify-center text-[#2F5D50] shadow-inner"
											>
												<i
													class="fa-solid fa-chart-line text-xl"
												></i>
											</div>
											<div>
												<h3
													class="text-lg font-bold text-gray-700"
												>
													Ingreso Actual
												</h3>
												<p
													class="text-xs text-gray-500"
												>
													Basado en citas concluidas
												</p>
											</div>
										</div>
										<input
											type="date"
											id="ingresos-date"
											class="glass-input rounded-lg px-2 py-1 text-xs font-bold text-[#2F5D50] outline-none focus:ring-2 focus:ring-[#2F5D50]/20 bg-white/50"
										/>
									</div>
									<div class="mt-auto z-10 pt-4">
										<div class="flex items-baseline gap-1">
											<span
												class="text-3xl font-bold text-[#2F5D50]"
												>$</span
											>
											<span
												id="ingresos-valor"
												class="text-6xl font-black text-[#2F5D50] tracking-tighter counter-value"
												data-target="450"
											>
												{
													benefit[0]
														?.total_ganancia || 0
												}</span
											>
										</div>
										<div
											class="mt-6 w-full bg-gray-200/50 rounded-full h-3 overflow-hidden"
										>
											<div
												class="bg-gradient-to-r from-[#2F5D50] to-[#4a9680] h-full rounded-full animate-pulse shadow-[0_0_10px_rgba(47,93,80,0.4)]"
												style="width: 45%"
											>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Resumen de Citas Card -->
							<div
								class="glass-panel rounded-3xl p-8 border border-white/60 !bg-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 min-h-[18rem] overflow-y-auto custom-scrollbar"
							>
								<div
									class="flex flex-wrap justify-between items-center mb-6 gap-4"
								>
									<div
										class="flex flex-wrap items-center gap-4"
									>
										<div
											class="w-12 h-12 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-600 shadow-inner"
										>
											<i
												class="fa-solid fa-calendar-check text-xl"
											></i>
										</div>
										<div>
											<h3
												class="text-lg font-bold text-gray-700"
											>
												Resumen
											</h3>
											<p class="text-xs text-gray-500">
												Estado de citas hoy
											</p>
										</div>
										<input
											type="date"
											id="account-appointment-date"
											class="glass-input rounded-lg px-2 py-1 text-xs font-bold text-[#2F5D50] outline-none focus:ring-2 focus:ring-[#2F5D50]/20 bg-white/50 w-full sm:w-auto"
										/>
									</div>
									<span
										class="bg-[#2F5D50] text-white text-xs font-bold px-4 py-1.5 rounded-full shadow-lg shadow-[#2F5D50]/20 flex items-center gap-2 ml-auto sm:ml-0"
									>
										Total: <span
											id="account-appointment-total"
											class="counter-value"
											data-target="6"
											>{
												appointmentStatus[0].citas
													.totalcitas || 0
											}</span
										>
									</span>
								</div>

								<div class="space-y-3">
									{
										[
											{
												label: "Concluidas",
												id: "account-appointment-concluidas",
												count:
													appointmentStatus[0].citas
														.concluidas || 0,
												color: "green",
												icon: "fa-check",
											},
											{
												label: "Confirmadas",
												id: "account-appointment-confirmadas",
												count:
													appointmentStatus[0].citas
														.confirmada || 0,
												color: "blue",
												icon: "fa-thumbs-up",
											},
											{
												label: "Pendientes",
												id: "account-appointment-pendientes",
												count:
													appointmentStatus[0].citas
														.espera || 0,
												color: "yellow",
												icon: "fa-clock",
											},
											{
												label: "Canceladas",
												id: "account-appointment-canceladas",
												count:
													appointmentStatus[0].citas
														.cancelada || 0,
												color: "red",
												icon: "fa-xmark",
											},
										].map((item) => (
											<div class="flex justify-between items-center p-3 hover:bg-white/60 rounded-xl transition-all cursor-default group border border-transparent hover:border-white/40">
												<div class="flex items-center gap-4">
													<div
														class={`w-3 h-3 rounded-full bg-${item.color}-500 shadow-[0_0_8px_rgba(0,0,0,0.3)] shadow-${item.color}-500/50 group-hover:scale-125 transition-transform`}
													/>
													<span class="text-sm font-semibold text-gray-600 group-hover:text-gray-900 transition-colors">
														{item.label}
													</span>
												</div>
												<span
													class="font-bold text-gray-800 bg-white/80 px-3 py-1 rounded-lg shadow-sm border border-gray-100 counter-value min-w-[2rem] text-center"
													data-target={item.count}
												>
													<span id={item.id}>
														{item.count}
													</span>
												</span>
											</div>
										))
									}
								</div>
							</div>
						</div>
					</div>

					<!-- Columna Derecha: Citas en Curso (4 columnas) -->
					<div class="lg:col-span-4 h-full min-h-[600px]">
						<div
							class="glass-panel rounded-3xl flex flex-col h-full overflow-hidden border border-white/60 !bg-white shadow-xl"
						>
							<div
								class="p-6 border-b border-[#2F5D50]/10 bg-white/40 backdrop-blur-md sticky top-0 z-20"
							>
								<div
									class="flex justify-between items-center mb-6"
								>
									<h2
										class="text-xl font-bold text-[#2F5D50] flex items-center gap-2"
									>
										<i class="fa-regular fa-calendar-days"
										></i>
										Agenda del Día
									</h2>
									<button
										class="w-10 h-10 rounded-xl bg-white/50 hover:bg-[#2F5D50] hover:text-white flex items-center justify-center text-[#2F5D50] transition-all shadow-sm"
									>
										<i class="fa-solid fa-filter"></i>
									</button>
								</div>
								<div class="relative group">
									<input
										type="date"
										id="appointment-date-calendar"
										class="w-full glass-input rounded-xl px-4 py-3 text-sm font-bold text-gray-700 outline-none focus:ring-2 focus:ring-[#2F5D50]/20 transition-all"
									/>
									<div
										class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-[#2F5D50] group-hover:scale-110 transition-transform"
									>
										<i class="fa-regular fa-calendar"></i>
									</div>
								</div>
							</div>

							<div
								class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar"
							>
								<div
									id="agenda-list-container"
									class="space-y-4"
								>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- Este script se encarga de cargar el grafico de barras -->
	<script
		type="text/javascript"
		src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript">
		google.charts.load("current", { packages: ["bar"] });
		google.charts.setOnLoadCallback(initChart);

		function initChart() {
			const startDateInput = document.getElementById("chart-date-start");
			const endDateInput = document.getElementById("chart-date-end");

			if (startDateInput && endDateInput) {
				const today = new Date().toISOString().split("T")[0];
				startDateInput.value = today;
				// endDateInput.value = today; // Optional: default end date to today as well

				// Initial draw with single date (today)
				fetchAndDrawChart(today, today);

				// Add listeners
				startDateInput.addEventListener("change", () => {
					fetchAndDrawChart(startDateInput.value, endDateInput.value);
				});

				endDateInput.addEventListener("change", () => {
					fetchAndDrawChart(startDateInput.value, endDateInput.value);
				});
			}
		}

		async function fetchAndDrawChart(startDate, endDate) {
			try {
				let url = `/api/v1/AdditionalSales?start=${startDate}`;
				if (endDate) {
					url += `&end=${endDate}`;
				} else {
					url += `&end=${startDate}`;
				}

				const res = await fetch(url);
				if (!res.ok) throw new Error("Failed to fetch chart data");
				const apiData = await res.json();
				drawChart(apiData);
			} catch (error) {
				console.error("Error loading chart data:", error);
				drawChart([]);
			}
		}

		function drawChart(apiData) {
			// Transform API data to Google Charts format
			// Expected format: [['', 'Emp1', 'Emp2'], ['Ventas', 10, 20]]

			const headerRow = [""];
			const dataRow = ["Ventas"];

			if (apiData && apiData.length > 0) {
				apiData.forEach((item) => {
					headerRow.push(item.empleado_nombre || "Desconocido");
					dataRow.push(Number(item.total_adicionales) || 0);
				});
			} else {
				// Default empty state
				headerRow.push("Sin datos");
				dataRow.push(0);
			}

			var data = google.visualization.arrayToDataTable([
				headerRow,
				dataRow,
			]);

			var options = {
				chart: {
					title: "",
					subtitle: "",
				},
				bars: "vertical",
				vAxis: {
					format: "decimal",
					textStyle: { color: "#333", bold: true },
				},
				hAxis: { textStyle: { color: "#333", bold: true } },
				height: "100%",
				colors: ["#2F5D50", "#4ade80", "#22d3ee", "#facc15", "#f87171"], // Added more colors
				backgroundColor: "transparent",
				legend: {
					position: "bottom",
					textStyle: { color: "#333", fontSize: 12 },
				},
				animation: {
					startup: true,
					duration: 1000,
					easing: "out",
				},
				chartArea: { width: "85%", height: "75%" },
			};

			var chart = new google.charts.Bar(
				document.getElementById("columnchart_material"),
			);

			chart.draw(data, google.charts.Bar.convertOptions(options));
		}

		window.addEventListener("resize", () => {
			const startDateInput = document.getElementById("chart-date-start");
			const endDateInput = document.getElementById("chart-date-end");
			if (startDateInput && endDateInput) {
				fetchAndDrawChart(startDateInput.value, endDateInput.value);
			}
		});
	</script>
	<!-- Script para Agenda Dinámica -->
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const agendaDateInput = document.getElementById(
				"appointment-date-calendar",
			);
			const agendaContainer = document.getElementById(
				"agenda-list-container",
			);

			if (agendaDateInput && agendaContainer) {
				const today = new Date().toISOString().split("T")[0];
				agendaDateInput.value = today;

				fetchAgenda(today);

				agendaDateInput.addEventListener("change", (e) => {
					fetchAgenda(e.target.value);
				});
			}

			async function fetchAgenda(date) {
				try {
					const res = await fetch(
						`/api/v1/Appointments?date=${date}`,
					);
					if (!res.ok) throw new Error("Failed to fetch agenda");
					const appointments = await res.json();
					renderAgenda(appointments);
				} catch (error) {
					console.error("Error loading agenda:", error);
					renderAgenda([]);
				}
			}

			function renderAgenda(appointments) {
				const container = document.getElementById(
					"agenda-list-container",
				);
				if (!container) return;

				container.innerHTML = "";

				if (!appointments || appointments.length === 0) {
					container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>No hay citas para esta fecha.</p>
                        </div>
                    `;
					return;
				}

				appointments.forEach((cita) => {
					const statusConfig = getStatusConfig(cita.status);
					const avatar = cita.patient_name
						? cita.patient_name.charAt(0).toUpperCase()
						: "?";

					const html = `
                        <div class="bg-white/60 hover:bg-white/90 transition-all duration-300 p-5 rounded-2xl border border-white/50 shadow-sm hover:shadow-lg cursor-pointer group relative overflow-hidden transform hover:-translate-y-1">
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-${statusConfig.color}-500"></div>

                            <div class="flex justify-between items-start mb-3 pl-3 flex-wrap gap-2">
                                <span class="font-bold text-[#2F5D50] text-xs bg-[#2F5D50]/10 px-2.5 py-1 rounded-lg flex items-center gap-1.5">
                                    <i class="fa-regular fa-clock"></i>
                                    ${cita.inithour}
                                </span>
                                <span class="text-[10px] uppercase tracking-wider px-2.5 py-1 rounded-full bg-${statusConfig.color}-100 text-${statusConfig.color}-700 font-bold shadow-sm">
                                    ${statusConfig.label}
                                </span>
                            </div>

                            <div class="flex items-center gap-4 pl-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#2F5D50] to-[#1a3c33] flex items-center justify-center text-white font-bold shadow-md group-hover:scale-110 transition-transform duration-300 border-2 border-white flex-shrink-0">
                                    ${avatar}
                                </div>
                                <div class="min-w-0">
                                    <h4 class="font-bold text-gray-800 leading-tight group-hover:text-[#2F5D50] transition-colors text-base truncate">
                                        ${cita.patient_name}
                                    </h4>
                                    <p class="text-xs text-gray-500 mt-1 font-medium flex items-center gap-1 flex-wrap">
                                        ${cita.name}
                                    </p>
                                </div>
                            </div>

                            <div class="absolute right-4 bottom-4 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0">
                                <div class="w-8 h-8 rounded-full bg-[#2F5D50] flex items-center justify-center text-white shadow-lg hover:bg-[#234D20]">
                                    <i class="fa-solid fa-chevron-right text-xs"></i>
                                </div>
                            </div>
                        </div>
                    `;
					container.insertAdjacentHTML("beforeend", html);
				});
			}

			function getStatusConfig(status) {
				const s = status ? status.toLowerCase() : "";
				if (s === "concluded" || s === "concluida") {
					return { color: "green", label: "Concluida" };
				} else if (s === "confirmed" || s === "confirmada") {
					return { color: "blue", label: "Confirmada" };
				} else if (s === "canceled" || s === "cancelada") {
					return { color: "red", label: "Cancelada" };
				} else {
					return { color: "yellow", label: "Pendiente" };
				}
			}
		});
	</script>
	<!-- Este script se encarga de actualizar el valor de ingresos acorde a la fecha seleccionada. -->
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const dateInput = document.getElementById("ingresos-date");
			const valorSpan = document.getElementById("ingresos-valor");

			if (dateInput) {
				const today = new Date().toISOString().split("T")[0];
				dateInput.value = today;
				dateInput.addEventListener("change", async (e) => {
					const date = e.target.value;
					try {
						const res = await fetch(`/api/v1/Benefit?date=${date}`);
						if (res.ok) {
							const data = await res.json();
							if (valorSpan) {
								if (data && data.length > 0) {
									valorSpan.textContent =
										data[0].total_ganancia;
								} else {
									valorSpan.textContent = "0";
								}
							}
						}
					} catch (err) {
						console.error(err);
					}
				});
			}
		});
	</script>
	<!-- Este script se encarga de actualizar el numero de citas acorde a la fecha seleccionada. -->
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const dateInput = document.getElementById(
				"account-appointment-date",
			);
			const citasTotalSpan = document.getElementById(
				"account-appointment-total",
			);
			const citasConcluidasSpan = document.getElementById(
				"account-appointment-concluidas",
			);
			const citasConfirmadasSpan = document.getElementById(
				"account-appointment-confirmadas",
			);
			const citasPendientesSpan = document.getElementById(
				"account-appointment-pendientes",
			);
			const citasCanceladasSpan = document.getElementById(
				"account-appointment-canceladas",
			);

			if (dateInput) {
				const today = new Date().toISOString().split("T")[0];
				dateInput.value = today;
				dateInput.addEventListener("change", async (e) => {
					const date = e.target.value;
					try {
						const res = await fetch(
							`/api/v1/AppointmentStatus?date=${date}`,
						);
						if (res.ok) {
							const data = await res.json();
							if (data && data.length > 0 && data[0].citas) {
								const citas = data[0].citas;
								if (citasTotalSpan)
									citasTotalSpan.textContent =
										citas.totalcitas || "0";
								if (citasConcluidasSpan)
									citasConcluidasSpan.textContent =
										citas.concluida || "0";
								if (citasConfirmadasSpan)
									citasConfirmadasSpan.textContent =
										citas.confirmada || "0";
								if (citasPendientesSpan)
									citasPendientesSpan.textContent =
										citas.espera || "0";
								if (citasCanceladasSpan)
									citasCanceladasSpan.textContent =
										citas.cancelada || "0";
							} else {
								if (citasTotalSpan)
									citasTotalSpan.textContent = "0";
								if (citasConcluidasSpan)
									citasConcluidasSpan.textContent = "0";
								if (citasConfirmadasSpan)
									citasConfirmadasSpan.textContent = "0";
								if (citasPendientesSpan)
									citasPendientesSpan.textContent = "0";
								if (citasCanceladasSpan)
									citasCanceladasSpan.textContent = "0";
							}
						}
					} catch (err) {
						console.error(err);
					}
				});
			}
		});
	</script>
</Layout>
