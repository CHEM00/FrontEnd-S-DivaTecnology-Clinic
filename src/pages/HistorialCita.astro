---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import NavBar from "../components/NavBar.astro";
import TopTag from "../components/TopTag.astro";

let historial = [];
try {
	const response = await fetch(
		"http://localhost:3000/api/v1/HistorialClinico",
	);
	if (response.ok) {
		historial = await response.json();
	} else {
		console.error("Error fetching historial:", response.status);
	}
} catch (error) {
	console.error("Error fetching historial:", error);
}
---

<Layout title="Historial de Citas">
	<div
		class="flex h-screen overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
	>
		<NavBar />

		<div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
			<!-- Background Elements -->
			<div
				class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
			>
			</div>
			<div
				class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
			>
			</div>

			<TopTag titulo="Historial Clínico" nombreUsuario="Administrador" />

			<main
				class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
			>
				<!-- Tabla Container -->
				<div
					class="glass-panel rounded-3xl overflow-hidden animate-fade-in-up stagger-2 border border-white/40 shadow-xl flex flex-col h-full max-h-[calc(100vh-140px)]"
				>
					<!-- Header de la tabla con Filtros -->
					<div
						class="p-6 border-b border-[#2F5D50]/10 bg-white/40 flex flex-col sm:flex-row justify-between items-center gap-4"
					>
						<h2
							class="text-xl font-bold text-[#2F5D50] flex items-center gap-2"
						>
							<i class="fa-solid fa-file-medical"></i>
							Registros
						</h2>

						<div
							class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto"
						>
							<!-- Buscador -->
							<div class="relative group w-full sm:w-64">
								<input
									type="text"
									id="searchInput"
									placeholder="Buscar paciente, fisio..."
									class="glass-input w-full rounded-xl pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
								/>
								<i
									class="fa-solid fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-[#2F5D50] transition-colors"
								></i>
							</div>

							<!-- Selector de Registros por página -->
							<div
								class="flex items-center gap-2 bg-white/50 px-3 py-2 rounded-xl border border-white/60"
							>
								<span
									class="text-xs font-bold text-gray-500 whitespace-nowrap"
									>Mostrar:</span
								>
								<select
									id="rowsPerPage"
									class="bg-transparent text-sm font-bold text-[#2F5D50] outline-none cursor-pointer"
								>
									<option value="5">5</option>
									<option value="10" selected>10</option>
								</select>
							</div>
						</div>
					</div>

					<!-- Tabla -->
					<div class="overflow-auto custom-scrollbar flex-1 relative">
						<table class="w-full text-left border-collapse">
							<thead
								class="sticky top-0 z-10 bg-white/95 backdrop-blur-md shadow-sm"
							>
								<tr
									class="text-[#2F5D50] border-b border-[#2F5D50]/10"
								>
									<th class="p-4 font-bold whitespace-nowrap"
										>Paciente</th
									>
									<th
										class="p-4 font-bold whitespace-nowrap text-center"
										>Fecha</th
									>
									<th
										class="p-4 font-bold whitespace-nowrap text-center"
										>Hora</th
									>
									<th
										class="p-4 font-bold whitespace-nowrap text-center"
										>Sesión</th
									>
									<th class="p-4 font-bold whitespace-nowrap"
										>Servicios</th
									>
									<th class="p-4 font-bold whitespace-nowrap"
										>Fisioterapeuta</th
									>
									<th
										class="p-4 font-bold whitespace-nowrap text-right"
										>Total</th
									>
								</tr>
							</thead>
							<tbody
								id="tableBody"
								class="divide-y divide-[#2F5D50]/5"
							>
								<!-- Contenido inyectado por JS -->
							</tbody>
						</table>

						<!-- Estado Vacío (oculto por defecto) -->
						<div
							id="emptyState"
							class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-white/50 backdrop-blur-sm"
						>
							<i
								class="fa-regular fa-folder-open text-4xl mb-2 opacity-50"
							></i>
							<p>No se encontraron registros</p>
						</div>
					</div>

					<!-- Paginación -->
					<div
						class="p-4 border-t border-[#2F5D50]/10 bg-white/40 flex justify-between items-center"
					>
						<span
							class="text-xs sm:text-sm text-gray-600 font-medium"
						>
							Mostrando <span
								id="showingStart"
								class="font-bold text-[#2F5D50]">0</span
							> - <span
								id="showingEnd"
								class="font-bold text-[#2F5D50]">0</span
							> de <span
								id="totalRecords"
								class="font-bold text-[#2F5D50]">0</span
							>
						</span>

						<div class="flex gap-2">
							<button
								id="prevBtn"
								class="w-9 h-9 rounded-lg flex items-center justify-center bg-white/60 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-sm border border-white/50"
							>
								<i class="fa-solid fa-chevron-left text-xs"></i>
							</button>
							<div id="pageNumbers" class="flex gap-1">
								<!-- Números de página generados dinámicamente -->
							</div>
							<button
								id="nextBtn"
								class="w-9 h-9 rounded-lg flex items-center justify-center bg-white/60 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-sm border border-white/50"
							>
								<i class="fa-solid fa-chevron-right text-xs"
								></i>
							</button>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- Script Cliente para Paginación y Filtro -->
	<script define:vars={{ historial }}>
		// Datos iniciales desde el servidor
		let allData = historial || [];
		let filteredData = [...allData];

		// Estado de la paginación
		let currentPage = 1;
		let rowsPerPage = 10;

		// Elementos DOM
		const tableBody = document.getElementById("tableBody");
		const emptyState = document.getElementById("emptyState");
		const searchInput = document.getElementById("searchInput");
		const rowsPerPageSelect = document.getElementById("rowsPerPage");
		const prevBtn = document.getElementById("prevBtn");
		const nextBtn = document.getElementById("nextBtn");
		const showingStart = document.getElementById("showingStart");
		const showingEnd = document.getElementById("showingEnd");
		const totalRecords = document.getElementById("totalRecords");

		// Helpers de formato
		const formatCurrency = (value) => {
			if (!value) return "$0.00";
			return new Intl.NumberFormat("es-MX", {
				style: "currency",
				currency: "MXN",
			}).format(parseFloat(value));
		};

		const formatDate = (dateString) => {
			if (!dateString) return "";
			// Ajustar zona horaria si es necesario, o usar UTC como string simple
			return new Date(dateString).toLocaleDateString("es-MX", {
				year: "numeric",
				month: "2-digit",
				day: "2-digit",
			});
		};

		// Función Principal de Renderizado
		function renderTable() {
			// Calcular índices
			const startIndex = (currentPage - 1) * rowsPerPage;
			const endIndex = Math.min(
				startIndex + rowsPerPage,
				filteredData.length,
			);
			const pageData = filteredData.slice(startIndex, endIndex);

			// Limpiar tabla
			tableBody.innerHTML = "";

			if (pageData.length === 0) {
				emptyState.classList.remove("hidden");
				showingStart.textContent = 0;
				showingEnd.textContent = 0;
				totalRecords.textContent = 0;
				updatePaginationControls();
				return;
			}

			emptyState.classList.add("hidden");

			// Generar filas
			pageData.forEach((item) => {
				const row = document.createElement("tr");
				row.className =
					"hover:bg-white/60 transition-colors group border-b border-transparent hover:border-[#2F5D50]/5";

				const initial = item.paciente
					? item.paciente.charAt(0).toUpperCase()
					: "?";
				const hora = item.hora_inicio
					? item.hora_inicio.substring(0, 5)
					: "--:--";
				const serviciosTags = item.servicios
					? item.servicios
							.split(",")
							.map(
								(s) =>
									`<span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full border border-gray-200 truncate max-w-full inline-block m-0.5">${s.trim()}</span>`,
							)
							.join("")
					: '<span class="text-xs text-gray-400 italic">Sin servicios</span>';

				row.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-[#2F5D50]/10 flex items-center justify-center text-[#2F5D50] font-bold text-xs shadow-sm">
                                ${initial}
                            </div>
                            <span class="font-bold text-gray-800 text-sm">${item.paciente || "Desconocido"}</span>
                        </div>
                    </td>
                    <td class="p-4 text-center whitespace-nowrap text-sm text-gray-600">
                        ${formatDate(item.fecha)}
                    </td>
                    <td class="p-4 text-center whitespace-nowrap text-sm text-gray-600 font-mono">
                        ${hora}
                    </td>
                    <td class="p-4 text-center">
                        <span class="bg-blue-50 text-blue-700 px-2.5 py-1 rounded-lg text-xs font-bold border border-blue-100 shadow-sm">
                            #${item.numero_sesion || "1"}
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="flex flex-wrap gap-1 max-w-[200px] sm:max-w-xs">
                            ${serviciosTags}
                        </div>
                    </td>
                    <td class="p-4 text-sm text-gray-700">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-user-doctor text-[#2F5D50]/50 text-xs"></i>
                            ${item.fisioterapeuta || "N/A"}
                        </div>
                    </td>
                    <td class="p-4 text-right font-bold text-[#2F5D50] whitespace-nowrap">
                        ${formatCurrency(item.total)}
                    </td>
                `;
				tableBody.appendChild(row);
			});

			// Actualizar info de paginación
			showingStart.textContent = startIndex + 1;
			showingEnd.textContent = endIndex;
			totalRecords.textContent = filteredData.length;

			updatePaginationControls();
		}

		function updatePaginationControls() {
			const totalPages = Math.ceil(filteredData.length / rowsPerPage);

			prevBtn.disabled = currentPage === 1;
			nextBtn.disabled = currentPage === totalPages || totalPages === 0;
		}

		// Event Listeners
		searchInput.addEventListener("input", (e) => {
			const term = e.target.value.toLowerCase();
			filteredData = allData.filter((item) => {
				return (
					(item.paciente &&
						item.paciente.toLowerCase().includes(term)) ||
					(item.fisioterapeuta &&
						item.fisioterapeuta.toLowerCase().includes(term)) ||
					(item.servicios &&
						item.servicios.toLowerCase().includes(term))
				);
			});
			currentPage = 1; // Resetear a primera página
			renderTable();
		});

		rowsPerPageSelect.addEventListener("change", (e) => {
			rowsPerPage = parseInt(e.target.value);
			currentPage = 1;
			renderTable();
		});

		prevBtn.addEventListener("click", () => {
			if (currentPage > 1) {
				currentPage--;
				renderTable();
			}
		});

		nextBtn.addEventListener("click", () => {
			const totalPages = Math.ceil(filteredData.length / rowsPerPage);
			if (currentPage < totalPages) {
				currentPage++;
				renderTable();
			}
		});

		// Inicializar
		renderTable();
	</script>
</Layout>
