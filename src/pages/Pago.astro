---
import Layout from "../layouts/Layout.astro";
import NavBar from "../components/NavBar.astro";
import TopTag from "../components/TopTag.astro";
import axios from "axios";

// Generar pagos automáticamente al cargar la vista
try {
    await axios.post("http://localhost:3001/api/v1/HistorialPagos/generar");
} catch (error) {
    console.error("Error generando pagos:", error);
}

let table = [];
let pacientes = [];

try {
    // Obtener el historial de pagos
    const pagosResponse = await axios.get(
        "http://localhost:3001/api/v1/HistorialPagos",
    );
    table = pagosResponse.data;

    // Obtener pacientes para el filtro
    const pacientesResponse = await axios.get(
        "http://localhost:3001/api/v1/Pacientes",
    );
    pacientes = pacientesResponse.data;
} catch (error) {
    console.error("Error fetching data:", error);
    table = [];
    pacientes = [];
}

// Función para formatear fecha
const formatDate = (dateString) => {
    if (!dateString) return "";
    const date = new Date(dateString);
    return date.toISOString().split("T")[0];
};
---

<Layout title="Historial de Pagos">
    <div
        class="flex h-[100dvh] overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
    >
        <NavBar />
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <!-- Background Elements for depth -->
            <div
                class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
            >
            </div>
            <div
                class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
            >
            </div>

            <TopTag titulo="Historial de Pagos" nombreUsuario="Administrador" />

            <main
                class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
            >
                <!-- Header con título y filtros -->
                <div
                    class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-8 gap-6 animate-fade-in-up stagger-1"
                >
                    <div>
                        <h1
                            class="text-3xl font-bold text-[#2F5D50] tracking-tight"
                        >
                            Historial Automático de Pagos
                        </h1>
                        <p class="text-gray-500 mt-1">
                            Registro detallado de transacciones y facturación
                        </p>
                    </div>

                    <div
                        class="glass-panel p-3 rounded-2xl flex flex-col sm:flex-row gap-3 w-full xl:w-auto shadow-lg border border-white/40"
                    >
                        <div class="relative group">
                            <select
                                id="filterPaciente"
                                class="glass-input pl-10 pr-8 py-2.5 rounded-xl text-sm min-w-[200px] appearance-none cursor-pointer hover:bg-white/60 transition-colors w-full focus:ring-2 focus:ring-[#2F5D50]/20 outline-none"
                            >
                                <option value="">Todos los pacientes</option>
                                {
                                    pacientes.map((paciente) => (
                                        <option value={paciente.id}>
                                            {paciente.firstname}{" "}
                                            {paciente.lastname}
                                        </option>
                                    ))
                                }
                            </select>
                            <div
                                class="absolute left-3 top-1/2 -translate-y-1/2 text-[#2F5D50]"
                            >
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-[#2F5D50] pointer-events-none"
                            >
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>

                        <div class="relative group">
                            <input
                                type="date"
                                id="filterFecha"
                                class="glass-input pl-10 pr-4 py-2.5 rounded-xl text-sm w-full focus:ring-2 focus:ring-[#2F5D50]/20 outline-none"
                            />
                            <div
                                class="absolute left-3 top-1/2 -translate-y-1/2 text-[#2F5D50]"
                            >
                                <i class="fa-regular fa-calendar"></i>
                            </div>
                        </div>

                        <div class="relative group">
                            <select
                                id="filterEstado"
                                class="glass-input pl-10 pr-8 py-2.5 rounded-xl text-sm appearance-none cursor-pointer hover:bg-white/60 transition-colors w-full focus:ring-2 focus:ring-[#2F5D50]/20 outline-none"
                            >
                                <option value="">Todos los estados</option>
                                <option value="completed">Completado</option>
                                <option value="pending">Pendiente</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                            <div
                                class="absolute left-3 top-1/2 -translate-y-1/2 text-[#2F5D50]"
                            >
                                <i class="fa-solid fa-tag"></i>
                            </div>
                            <div
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-[#2F5D50] pointer-events-none"
                            >
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>

                        <div class="flex gap-2 w-full sm:w-auto">
                            <button
                                class="glass-button px-5 py-2.5 rounded-xl text-white bg-[#2F5D50] hover:bg-[#234D20] font-medium transition-all shadow-md hover:shadow-lg flex-1 sm:flex-none flex items-center justify-center gap-2"
                                onclick="filtrarPagos()"
                            >
                                <i class="fa-solid fa-filter"></i>Filtrar
                            </button>
                            <button
                                class="glass-button px-5 py-2.5 rounded-xl text-[#2F5D50] hover:bg-white/60 font-medium transition-all shadow-sm hover:shadow-md flex-1 sm:flex-none flex items-center justify-center gap-2"
                                onclick="limpiarFiltros()"
                            >
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla Container -->
                <div
                    class="glass-panel rounded-3xl overflow-hidden animate-fade-in-up stagger-2 border border-white/40 shadow-xl"
                >
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-[#2F5D50]/5 text-[#2F5D50] border-b border-[#2F5D50]/10"
                                >
                                    <th
                                        class="p-5 font-bold whitespace-nowrap rounded-tl-2xl"
                                        >Fecha Cita</th
                                    >
                                    <th class="p-5 font-bold whitespace-nowrap"
                                        >Paciente</th
                                    >
                                    <th class="p-5 font-bold whitespace-nowrap"
                                        >Servicio</th
                                    >
                                    <th
                                        class="p-5 font-bold text-center whitespace-nowrap"
                                        >Cant.</th
                                    >
                                    <th
                                        class="p-5 font-bold text-right whitespace-nowrap"
                                        >Precio Unit.</th
                                    >
                                    <th
                                        class="p-5 font-bold text-right whitespace-nowrap"
                                        >Subtotal</th
                                    >
                                    <th
                                        class="p-5 font-bold text-right whitespace-nowrap"
                                        >IVA</th
                                    >
                                    <th
                                        class="p-5 font-bold text-right whitespace-nowrap"
                                        >Total</th
                                    >
                                    <th
                                        class="p-5 font-bold text-center whitespace-nowrap"
                                        >Método</th
                                    >
                                    <th
                                        class="p-5 font-bold text-center whitespace-nowrap rounded-tr-2xl"
                                        >Estado</th
                                    >
                                </tr>
                            </thead>
                            <tbody
                                class="divide-y divide-[#2F5D50]/5"
                                id="tablaPagosBody"
                            >
                                {
                                    table.map((pago) => (
                                        <tr class="hover:bg-white/60 transition-colors group">
                                            <td class="p-5 text-sm font-medium text-gray-700 whitespace-nowrap">
                                                <div class="flex items-center gap-2">
                                                    <div class="w-8 h-8 rounded-lg bg-[#2F5D50]/10 flex items-center justify-center text-[#2F5D50]">
                                                        <i class="fa-regular fa-calendar" />
                                                    </div>
                                                    {formatDate(
                                                        pago.appointmentdate,
                                                    )}
                                                </div>
                                            </td>
                                            <td class="p-5 font-bold text-gray-800 whitespace-nowrap">
                                                {pago.patientname}
                                            </td>
                                            <td class="p-5 text-sm text-gray-600 whitespace-nowrap">
                                                <span class="bg-white/50 px-3 py-1 rounded-lg border border-white/40">
                                                    {pago.productname}
                                                </span>
                                            </td>
                                            <td class="p-5 text-center text-sm font-bold text-[#2F5D50]">
                                                {pago.quantity}
                                            </td>
                                            <td class="p-5 text-right text-sm text-gray-600">
                                                ${pago.unitprice}
                                            </td>
                                            <td class="p-5 text-right text-sm text-gray-600">
                                                ${pago.subtotal}
                                            </td>
                                            <td class="p-5 text-right text-sm text-gray-600">
                                                ${pago.iva}
                                            </td>
                                            <td class="p-5 text-right font-bold text-[#2F5D50] text-lg">
                                                ${pago.total}
                                            </td>
                                            <td class="p-5 text-center">
                                                <span
                                                    class={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-sm border ${
                                                        pago.paymentmethod ===
                                                        "cash"
                                                            ? "bg-green-100 text-green-700 border-green-200"
                                                            : pago.paymentmethod ===
                                                                "card"
                                                              ? "bg-blue-100 text-blue-700 border-blue-200"
                                                              : pago.paymentmethod ===
                                                                  "transfer"
                                                                ? "bg-purple-100 text-purple-700 border-purple-200"
                                                                : "bg-gray-100 text-gray-600 border-gray-200"
                                                    }`}
                                                >
                                                    {pago.paymentmethod ===
                                                    "cash"
                                                        ? "Efectivo"
                                                        : pago.paymentmethod ===
                                                            "card"
                                                          ? "Tarjeta"
                                                          : pago.paymentmethod ===
                                                              "transfer"
                                                            ? "Transferencia"
                                                            : "Pendiente"}
                                                </span>
                                            </td>
                                            <td class="p-5 text-center">
                                                <span
                                                    class={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-sm border ${
                                                        pago.status ===
                                                        "completed"
                                                            ? "bg-green-100 text-green-700 border-green-200"
                                                            : pago.status ===
                                                                "pending"
                                                              ? "bg-yellow-100 text-yellow-700 border-yellow-200"
                                                              : "bg-red-100 text-red-700 border-red-200"
                                                    }`}
                                                >
                                                    {pago.status === "completed"
                                                        ? "Completado"
                                                        : pago.status ===
                                                            "pending"
                                                          ? "Pendiente"
                                                          : "Cancelado"}
                                                </span>
                                            </td>
                                        </tr>
                                    ))
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div
                        class="p-4 border-t border-[#2F5D50]/10 flex justify-between items-center bg-white/30 backdrop-blur-sm"
                    >
                        <div class="text-sm text-gray-600 font-medium">
                            Mostrando <span
                                class="font-bold text-[#2F5D50]"
                                id="totalRegistros">{table.length}</span
                            > registros
                        </div>
                        <div class="flex gap-2">
                            <button
                                class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:hover:bg-white/50 disabled:hover:text-[#2F5D50] shadow-sm"
                                disabled
                            >
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <button
                                class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/50 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all shadow-sm"
                            >
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Función para formatear fecha (cliente)
        const formatDate = (dateString) => {
            if (!dateString) return "";
            const date = new Date(dateString);
            return date.toISOString().split("T")[0];
        };

        // Función para filtrar pagos
        window.filtrarPagos = async function () {
            const pacienteId = document.getElementById("filterPaciente").value;
            const fecha = document.getElementById("filterFecha").value;
            const estado = document.getElementById("filterEstado").value;

            let url = "/api/v1/HistorialPagos";

            if (pacienteId) {
                url = `/api/v1/HistorialPagos/paciente/${pacienteId}`;
            } else if (fecha) {
                url = `/api/v1/HistorialPagos/fecha/${fecha}`;
            }

            try {
                const response = await fetch(url);
                let pagos = await response.json();

                // Filtrar por estado si se seleccionó
                if (estado) {
                    pagos = pagos.filter((pago) => pago.status === estado);
                }

                actualizarTabla(pagos);
            } catch (error) {
                console.error("Error filtrando pagos:", error);
                alert("Error al aplicar filtros");
            }
        };

        // Función para actualizar la tabla
        function actualizarTabla(pagos) {
            const tbody = document.getElementById("tablaPagosBody");
            tbody.innerHTML = "";

            document.getElementById("totalRegistros").textContent =
                pagos.length;

            pagos.forEach((pago) => {
                const tr = document.createElement("tr");
                tr.className = "hover:bg-white/60 transition-colors group";

                // Determinar clases de badges
                const metodoClass =
                    pago.paymentmethod === "cash"
                        ? "bg-green-100 text-green-700 border-green-200"
                        : pago.paymentmethod === "card"
                          ? "bg-blue-100 text-blue-700 border-blue-200"
                          : pago.paymentmethod === "transfer"
                            ? "bg-purple-100 text-purple-700 border-purple-200"
                            : "bg-gray-100 text-gray-600 border-gray-200";

                const metodoTexto =
                    pago.paymentmethod === "cash"
                        ? "Efectivo"
                        : pago.paymentmethod === "card"
                          ? "Tarjeta"
                          : pago.paymentmethod === "transfer"
                            ? "Transferencia"
                            : "Pendiente";

                const estadoClass =
                    pago.status === "completed"
                        ? "bg-green-100 text-green-700 border-green-200"
                        : pago.status === "pending"
                          ? "bg-yellow-100 text-yellow-700 border-yellow-200"
                          : "bg-red-100 text-red-700 border-red-200";

                const estadoTexto =
                    pago.status === "completed"
                        ? "Completado"
                        : pago.status === "pending"
                          ? "Pendiente"
                          : "Cancelado";

                tr.innerHTML = `
                    <td class="p-5 text-sm font-medium text-gray-700 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                             <div class="w-8 h-8 rounded-lg bg-[#2F5D50]/10 flex items-center justify-center text-[#2F5D50]">
                                <i class="fa-regular fa-calendar" />
                            </div>
                            ${formatDate(pago.appointmentdate)}
                        </div>
                    </td>
                    <td class="p-5 font-bold text-gray-800 whitespace-nowrap">${pago.patientname}</td>
                    <td class="p-5 text-sm text-gray-600 whitespace-nowrap">
                        <span class="bg-white/50 px-3 py-1 rounded-lg border border-white/40">
                            ${pago.productname}
                        </span>
                    </td>
                    <td class="p-5 text-center text-sm font-bold text-[#2F5D50]">${pago.quantity}</td>
                    <td class="p-5 text-right text-sm text-gray-600">$${pago.unitprice}</td>
                    <td class="p-5 text-right text-sm text-gray-600">$${pago.subtotal}</td>
                    <td class="p-5 text-right text-sm text-gray-600">$${pago.iva}</td>
                    <td class="p-5 text-right font-bold text-[#2F5D50] text-lg">$${pago.total}</td>
                    <td class="p-5 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-sm border ${metodoClass}">
                            ${metodoTexto}
                        </span>
                    </td>
                    <td class="p-5 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-sm border ${estadoClass}">
                            ${estadoTexto}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Re-aplicar animaciones a las nuevas filas
            // if (typeof gsap !== "undefined") {
            //     gsap.from("#tablaPagosBody tr", {
            //         duration: 0.5,
            //         opacity: 0,
            //         y: 10,
            //         stagger: 0.05,
            //         ease: "power2.out",
            //     });
            // }
        }

        // Función para limpiar filtros
        window.limpiarFiltros = function () {
            document.getElementById("filterPaciente").value = "";
            document.getElementById("filterFecha").value = "";
            document.getElementById("filterEstado").value = "";
            location.reload();
        };

        // Event Listeners
        document.addEventListener("DOMContentLoaded", function () {
            // GSAP Animations
            // GSAP Animations
            // if (typeof gsap !== "undefined") {
            //     gsap.from(".glass-panel", {
            //         duration: 0.8,
            //         y: 30,
            //         opacity: 0,
            //         stagger: 0.1,
            //         ease: "power3.out",
            //     });
            //     gsap.from("tr", {
            //         duration: 0.5,
            //         opacity: 0,
            //         y: 10,
            //         stagger: 0.05,
            //         delay: 0.2,
            //         ease: "power2.out",
            //     });
            // }
        });
    </script>
</Layout>
