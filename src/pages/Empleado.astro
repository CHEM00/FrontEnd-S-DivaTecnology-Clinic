---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import NavBar from "../components/NavBar.astro";
import TopTag from "../components/TopTag.astro";
import FormModal from "../components/modals/FormModal.astro";

let table = [];

const backendUrl = import.meta.env.BACKEND_URL;
const token = Astro.cookies.get("auth_token")?.value;
const headers = {
	"Content-Type": "application/json",
	...(token && { Cookie: `auth_token=${token}` }),
};

const { Agent } = await import("node:https");
const agent = new Agent({ rejectUnauthorized: false });

try {
	// @ts-ignore
	const response = await fetch(`${backendUrl}/api/v1/Trabajadores`, {
		headers,
		agent,
	});
	if (response.ok) {
		table = await response.json();
	} else {
		console.error("Error en la respuesta:", response.status);
		table = [];
	}
} catch (error) {
	console.error("Error fetching data:", error);
	table = [];
}
---

<Layout title="Empleados">
	<div
		class="flex h-screen overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
	>
		<NavBar />
		<div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
			<!-- Background Elements -->
			<div
				class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
			>
			</div>
			<div
				class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
			>
			</div>

			<TopTag titulo="Gestión de Empleados" nombreUsuario="Administrador">
				<button
					class="glass-button px-4 py-2 rounded-xl flex items-center gap-2 text-white bg-[#2F5D50] hover:bg-[#234D20] transition-all shadow-lg hover:shadow-[#2F5D50]/30 transform hover:-translate-y-1"
					onclick="abrirModal('modalFormulario', 'crear')"
				>
					<div
						class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center"
					>
						<i class="fa-solid fa-user-plus text-xs"></i>
					</div>
					<span class="font-semibold text-sm hidden sm:inline"
						>Nuevo Empleado</span
					>
				</button>
			</TopTag>

			<main
				class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
			>
				<!-- Tabla Container -->
				<div
					class="glass-panel rounded-3xl overflow-hidden animate-fade-in-up stagger-2 border border-white/40 shadow-xl flex flex-col h-full max-h-[calc(100vh-140px)]"
				>
					<!-- Header de la tabla con Filtros -->
					<div
						class="p-6 border-b border-[#2F5D50]/10 bg-white/40 flex flex-col sm:flex-row justify-between items-center gap-4"
					>
						<h2
							class="text-xl font-bold text-[#2F5D50] flex items-center gap-2"
						>
							<i class="fa-solid fa-users"></i>
							Personal
						</h2>

						<div
							class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto"
						>
							<!-- Buscador -->
							<div class="relative group w-full sm:w-64">
								<input
									type="text"
									id="searchInput"
									placeholder="Buscar por nombre, correo..."
									class="glass-input w-full rounded-xl pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
								/>
								<i
									class="fa-solid fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-[#2F5D50] transition-colors"
								></i>
							</div>

							<!-- Selector de Registros por página -->
							<div
								class="flex items-center gap-2 bg-white/50 px-3 py-2 rounded-xl border border-white/60"
							>
								<span
									class="text-xs font-bold text-gray-500 whitespace-nowrap"
									>Mostrar:</span
								>
								<select
									id="rowsPerPage"
									class="bg-transparent text-sm font-bold text-[#2F5D50] outline-none cursor-pointer"
								>
									<option value="5">5</option>
									<option value="10" selected>10</option>
								</select>
							</div>
						</div>
					</div>

					<div class="overflow-auto custom-scrollbar flex-1 relative">
						<table class="w-full text-left border-collapse">
							<thead
								class="sticky top-0 z-10 bg-white/95 backdrop-blur-md shadow-sm"
							>
								<tr
									class="text-[#2F5D50] border-b border-[#2F5D50]/10"
								>
									<th class="p-4 font-bold whitespace-nowrap"
										>Nombre</th
									>
									<th
										class="p-4 font-bold whitespace-nowrap hidden md:table-cell"
										>Apellidos</th
									>
									<th
										class="p-4 font-bold whitespace-nowrap hidden lg:table-cell"
										>Contacto</th
									>
									<th
										class="p-4 font-bold whitespace-nowrap hidden xl:table-cell"
										>Fecha Nac.</th
									>
									<th
										class="p-4 font-bold whitespace-nowrap text-center w-20"
										>Acciones</th
									>
								</tr>
							</thead>
							<tbody
								id="tableBody"
								class="divide-y divide-[#2F5D50]/5"
							>
								<!-- Contenido inyectado por JS -->
							</tbody>
						</table>

						<!-- Estado Vacío -->
						<div
							id="emptyState"
							class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-white/50 backdrop-blur-sm"
						>
							<i
								class="fa-regular fa-folder-open text-4xl mb-2 opacity-50"
							></i>
							<p>No se encontraron empleados</p>
						</div>
					</div>

					<!-- Paginación -->
					<div
						class="p-4 border-t border-[#2F5D50]/10 bg-white/40 flex justify-between items-center"
					>
						<span
							class="text-xs sm:text-sm text-gray-600 font-medium"
						>
							Mostrando <span
								id="showingStart"
								class="font-bold text-[#2F5D50]">0</span
							> - <span
								id="showingEnd"
								class="font-bold text-[#2F5D50]">0</span
							> de <span
								id="totalRecords"
								class="font-bold text-[#2F5D50]">0</span
							>
						</span>

						<div class="flex gap-2">
							<button
								id="prevBtn"
								class="w-9 h-9 rounded-lg flex items-center justify-center bg-white/60 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-sm border border-white/50"
							>
								<i class="fa-solid fa-chevron-left text-xs"></i>
							</button>
							<div id="pageNumbers" class="flex gap-1"></div>
							<button
								id="nextBtn"
								class="w-9 h-9 rounded-lg flex items-center justify-center bg-white/60 text-[#2F5D50] hover:bg-[#2F5D50] hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-sm border border-white/50"
							>
								<i class="fa-solid fa-chevron-right text-xs"
								></i>
							</button>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- Modal Confirmar Eliminar -->
	<div id="modalEliminar" class="fixed inset-0 z-50 hidden">
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm"
			onclick="cerrarModal('modalEliminar')"
		>
		</div>
		<div class="flex min-h-full items-center justify-center p-4">
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:w-full sm:max-w-md p-6"
			>
				<div class="text-center">
					<div
						class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100 mb-4"
					>
						<i
							class="fa-solid fa-triangle-exclamation text-3xl text-red-600"
						></i>
					</div>
					<h3 class="text-xl font-bold text-gray-900">
						¿Eliminar empleado?
					</h3>
					<p class="text-sm text-gray-500 mt-2">
						Estás a punto de eliminar a <span
							id="nombreEmpleadoEliminar"
							class="font-bold text-gray-800"></span>. Esta acción
						no se puede deshacer.
					</p>
				</div>
				<div class="mt-6 flex gap-3">
					<button
						type="button"
						class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium"
						onclick="cerrarModal('modalEliminar')">Cancelar</button
					>
					<button
						type="button"
						id="btnConfirmarEliminar"
						class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium shadow-lg shadow-red-600/30"
						>Sí, Eliminar</button
					>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Formulario (Crear/Editar) -->
	<FormModal
		id="modalFormulario"
		title="Nuevo Empleado"
		formId="empleadoForm"
		submitText="Guardar"
		cancelText="Cancelar"
		size="lg"
	>
		<input type="hidden" id="empleadoId" name="Id" />

		<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<div class="space-y-4">
				<h4
					class="font-semibold text-[#2F5D50] border-b border-[#2F5D50]/20 pb-2"
				>
					Información Personal
				</h4>
				<div>
					<label class="block text-sm font-bold text-gray-700 mb-1"
						>Nombre *</label
					>
					<input
						type="text"
						name="FirstName"
						id="FirstName"
						class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
						required
						placeholder="Ej: Juan"
					/>
				</div>
				<div class="grid grid-cols-2 gap-4">
					<div>
						<label
							class="block text-sm font-bold text-gray-700 mb-1"
							>Apellido Paterno *</label
						>
						<input
							type="text"
							name="LastName"
							id="LastName"
							class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
							required
							placeholder="Ej: Pérez"
						/>
					</div>
					<div>
						<label
							class="block text-sm font-bold text-gray-700 mb-1"
							>Apellido Materno *</label
						>
						<input
							type="text"
							name="MotherLastName"
							id="MotherLastName"
							class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
							required
							placeholder="Ej: López"
						/>
					</div>
				</div>
				<div>
					<label class="block text-sm font-bold text-gray-700 mb-1"
						>Fecha de Nacimiento</label
					>
					<input
						type="date"
						name="BirthDate"
						id="BirthDate"
						class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
					/>
				</div>
			</div>

			<div class="space-y-4">
				<h4
					class="font-semibold text-[#2F5D50] border-b border-[#2F5D50]/20 pb-2"
				>
					Contacto y Cuenta
				</h4>
				<div>
					<label class="block text-sm font-bold text-gray-700 mb-1"
						>Teléfono *</label
					>
					<input
						type="tel"
						name="Phone"
						id="Phone"
						class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
						required
						placeholder="10 dígitos"
						maxlength="10"
						pattern="[0-9]{10}"
					/>
				</div>
				<div>
					<label class="block text-sm font-bold text-gray-700 mb-1"
						>Correo Electrónico *</label
					>
					<input
						type="email"
						name="Email"
						id="Email"
						class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
						required
						placeholder="correo@ejemplo.com"
					/>
				</div>
				<div>
					<label class="block text-sm font-bold text-gray-700 mb-1"
						>Contraseña</label
					>
					<input
						type="password"
						name="Password"
						id="Password"
						class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
						placeholder="••••••••"
					/>
					<p
						class="text-xs text-gray-500 mt-1 hidden"
						id="passwordHint"
					>
						Dejar en blanco para mantener la actual
					</p>
				</div>
				<div>
					<label class="block text-sm font-bold text-gray-700 mb-1"
						>Foto (URL)</label
					>
					<input
						type="url"
						name="Photo"
						id="Photo"
						class="glass-input w-full rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
						placeholder="https://..."
					/>
				</div>
			</div>
		</div>
	</FormModal>

	<!-- Modal Exito -->
	<div id="modalExito" class="fixed inset-0 z-[60] hidden">
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm"
			onclick="cerrarModal('modalExito')"
		>
		</div>
		<div class="flex min-h-full items-center justify-center p-4">
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:w-full sm:max-w-sm p-6 text-center"
			>
				<div
					class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100 mb-4"
				>
					<i class="fa-solid fa-check text-green-600 text-xl"></i>
				</div>
				<h3 class="text-lg font-bold text-gray-900 mb-2">¡Éxito!</h3>
				<p id="mensajeExito" class="text-sm text-gray-500 mb-4"></p>
				<button
					type="button"
					class="w-full px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 font-medium"
					onclick="cerrarModal('modalExito')">Aceptar</button
				>
			</div>
		</div>
	</div>

	<!-- Modal Error -->
	<div id="modalError" class="fixed inset-0 z-[60] hidden">
		<div
			class="fixed inset-0 bg-black/40 backdrop-blur-sm"
			onclick="cerrarModal('modalError')"
		>
		</div>
		<div class="flex min-h-full items-center justify-center p-4">
			<div
				class="relative transform overflow-hidden rounded-2xl glass-panel text-left shadow-2xl transition-all sm:w-full sm:max-w-sm p-6 text-center"
			>
				<div
					class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 mb-4"
				>
					<i class="fa-solid fa-xmark text-red-600 text-xl"></i>
				</div>
				<h3 class="text-lg font-bold text-gray-900 mb-2">Error</h3>
				<p id="mensajeError" class="text-sm text-gray-500 mb-4"></p>
				<button
					type="button"
					class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium"
					onclick="cerrarModal('modalError')">Aceptar</button
				>
			</div>
		</div>
	</div>

	<script define:vars={{ table }}>
		// Datos y Estado
		let allData = table || [];
		let filteredData = [...allData];
		let currentPage = 1;
		let rowsPerPage = 10;
		let selectedEmpleadoId = null;

		// Elementos DOM
		const tableBody = document.getElementById("tableBody");
		const emptyState = document.getElementById("emptyState");
		const searchInput = document.getElementById("searchInput");
		const rowsPerPageSelect = document.getElementById("rowsPerPage");
		const prevBtn = document.getElementById("prevBtn");
		const nextBtn = document.getElementById("nextBtn");
		const showingStart = document.getElementById("showingStart");
		const showingEnd = document.getElementById("showingEnd");
		const totalRecords = document.getElementById("totalRecords");

		// Helpers
		const formatDate = (dateString) => {
			if (!dateString) return "";
			return new Date(dateString).toLocaleDateString("es-MX", {
				year: "numeric",
				month: "2-digit",
				day: "2-digit",
			});
		};

		// Renderizado de Tabla
		function renderTable() {
			const startIndex = (currentPage - 1) * rowsPerPage;
			const endIndex = Math.min(
				startIndex + rowsPerPage,
				filteredData.length,
			);
			const pageData = filteredData.slice(startIndex, endIndex);

			tableBody.innerHTML = "";

			if (pageData.length === 0) {
				emptyState.classList.remove("hidden");
				showingStart.textContent = 0;
				showingEnd.textContent = 0;
				totalRecords.textContent = 0;
				updatePaginationControls();
				return;
			}

			emptyState.classList.add("hidden");

			pageData.forEach((empleado) => {
				const row = document.createElement("tr");
				row.className =
					"hover:bg-white/60 transition-colors group border-b border-transparent hover:border-[#2F5D50]/5";

				const photoHtml = empleado.Photo
					? `<img src="${empleado.Photo}" alt="Foto" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm" />`
					: `<div class="w-10 h-10 rounded-full bg-[#2F5D50]/10 flex items-center justify-center text-[#2F5D50] shadow-sm"><i class="fa-solid fa-user"></i></div>`;

				row.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            ${photoHtml}
                            <div>
                                <div class="font-bold text-gray-800 text-sm">${empleado.FirstName}</div>
                                <div class="text-xs text-gray-500 md:hidden">${empleado.LastName}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 hidden md:table-cell text-sm text-gray-700 font-medium">
                        ${empleado.LastName} ${empleado.MotherLastName}
                    </td>
                    <td class="p-4 hidden lg:table-cell">
                        <div class="flex flex-col gap-0.5">
                            <span class="text-xs text-gray-700 font-medium flex items-center gap-1.5">
                                <i class="fa-solid fa-phone text-[#2F5D50]/60 text-[10px]"></i>
                                ${empleado.Phone}
                            </span>
                            <span class="text-[10px] text-gray-500 flex items-center gap-1.5">
                                <i class="fa-solid fa-envelope text-[#2F5D50]/60 text-[10px]"></i>
                                ${empleado.Email}
                            </span>
                        </div>
                    </td>
                    <td class="p-4 hidden xl:table-cell">
                        <div class="text-gray-600 text-xs font-medium bg-white/50 px-2 py-1 rounded-lg border border-white/40 inline-flex items-center gap-1.5">
                            <i class="fa-solid fa-cake-candles text-[#2F5D50]/60"></i>
                            ${formatDate(empleado.BirthDate)}
                        </div>
                    </td>
                    <td class="p-4 text-center relative">
                        <div class="dropdown relative inline-block text-left">
                            <button 
                                type="button" 
                                class="w-8 h-8 rounded-lg hover:bg-[#2F5D50]/10 text-gray-500 hover:text-[#2F5D50] transition-colors flex items-center justify-center"
                                onclick="event.stopPropagation(); toggleDropdown('dropdown-${empleado.Id}')"
                            >
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                            </button>
                            <div 
                                id="dropdown-${empleado.Id}" 
                                class="dropdown-menu hidden absolute right-0 mt-2 w-48 rounded-xl bg-white shadow-xl border border-gray-100 z-50 animate-fade-in-up origin-top-right"
                                onclick="event.stopPropagation()"
                            >
                                <div class="py-1">
                                    <button 
                                        class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-[#2F5D50] flex items-center gap-2 transition-colors"
                                        onclick="verDetallesEmpleado('${empleado.Id}'); toggleDropdown('dropdown-${empleado.Id}')"
                                    >
                                        <i class="fa-regular fa-pen-to-square"></i> Editar
                                    </button>
                                    <button 
                                        class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors"
                                        onclick="confirmarEliminacion('${empleado.Id}', '${empleado.FirstName} ${empleado.LastName}'); toggleDropdown('dropdown-${empleado.Id}')"
                                    >
                                        <i class="fa-regular fa-trash-can"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
				tableBody.appendChild(row);
			});

			showingStart.textContent = startIndex + 1;
			showingEnd.textContent = endIndex;
			totalRecords.textContent = filteredData.length;
			updatePaginationControls();
		}

		function updatePaginationControls() {
			const totalPages = Math.ceil(filteredData.length / rowsPerPage);
			prevBtn.disabled = currentPage === 1;
			nextBtn.disabled = currentPage === totalPages || totalPages === 0;

			const pageNumbers = document.getElementById("pageNumbers");
			pageNumbers.innerHTML = "";
			if (totalPages > 1) {
				const span = document.createElement("span");
				span.className =
					"text-xs font-medium text-gray-500 self-center px-2";
				span.textContent = `Página ${currentPage} de ${totalPages}`;
				pageNumbers.appendChild(span);
			}
		}

		// --- Modales y Acciones ---

		// Función unificada para abrir modal (estilo Paciente.astro)
		window.abrirModal = function (id, modo) {
			const modal = document.getElementById(id);
			if (!modal) return;

			modal.classList.remove("hidden");

			// Animación
			const content = modal.querySelector(".modal-content-wrapper");
			if (content) {
				setTimeout(() => {
					content.classList.remove("scale-95", "opacity-0");
					content.classList.add("scale-100", "opacity-100");
				}, 10);
			}

			if (id === "modalFormulario") {
				const form = document.getElementById("empleadoForm");
				const title = document.getElementById(
					"modal-title-modalFormulario",
				);
				const passwordHint = document.getElementById("passwordHint");

				if (modo === "crear") {
					if (title) title.textContent = "Nuevo Empleado";
					form.reset();
					document.getElementById("empleadoId").value = "";
					if (passwordHint) passwordHint.classList.add("hidden");
					document.getElementById("Password").required = true;
				} else if (modo === "editar") {
					if (title) title.textContent = "Editar Empleado";
					if (passwordHint) passwordHint.classList.remove("hidden");
					document.getElementById("Password").required = false;
				}
			}
		};

		window.cerrarModal = function (id) {
			const modal = document.getElementById(id);
			if (!modal) return;

			const content = modal.querySelector(".modal-content-wrapper");
			if (content) {
				content.classList.remove("scale-100", "opacity-100");
				content.classList.add("scale-95", "opacity-0");
				setTimeout(() => {
					modal.classList.add("hidden");
				}, 300);
			} else {
				modal.classList.add("hidden");
			}
		};

		window.verDetallesEmpleado = function (id) {
			const empleado = allData.find((e) => e.Id == id);
			if (!empleado) {
				console.error("Empleado no encontrado:", id);
				return;
			}

			abrirModal("modalFormulario", "editar");

			// Llenar formulario
			document.getElementById("empleadoId").value = empleado.Id;
			document.getElementById("FirstName").value =
				empleado.FirstName || "";
			document.getElementById("LastName").value = empleado.LastName || "";
			document.getElementById("MotherLastName").value =
				empleado.MotherLastName || "";
			document.getElementById("Phone").value = empleado.Phone || "";
			document.getElementById("Email").value = empleado.Email || "";
			document.getElementById("BirthDate").value = empleado.BirthDate
				? empleado.BirthDate.split("T")[0]
				: "";
			document.getElementById("Photo").value = empleado.Photo || "";
			document.getElementById("Password").value = "";
		};

		window.confirmarEliminacion = function (id, nombre) {
			selectedEmpleadoId = id;
			document.getElementById("nombreEmpleadoEliminar").textContent =
				nombre;
			document.getElementById("modalEliminar").classList.remove("hidden");
		};

		// Dropdown logic
		window.toggleDropdown = function (id) {
			document.querySelectorAll(".dropdown-menu").forEach((menu) => {
				if (menu.id !== id) menu.classList.add("hidden");
			});
			const dropdown = document.getElementById(id);
			if (dropdown) dropdown.classList.toggle("hidden");
		};

		window.addEventListener("click", (e) => {
			if (!e.target.closest(".dropdown")) {
				document.querySelectorAll(".dropdown-menu").forEach((menu) => {
					menu.classList.add("hidden");
				});
			}
		});

		// --- API Calls ---

		// Guardar (Crear/Editar)
		document
			.getElementById("empleadoForm")
			.addEventListener("submit", async (e) => {
				e.preventDefault();
				const form = e.target;
				const formData = new FormData(form);
				const id = formData.get("Id");
				const isEdit = !!id;

				const data = {
					FirstName: formData.get("FirstName"),
					LastName: formData.get("LastName"),
					MotherLastName: formData.get("MotherLastName"),
					Phone: formData.get("Phone"),
					Email: formData.get("Email"),
					BirthDate: formData.get("BirthDate"),
					Photo: formData.get("Photo"),
					idrol: 2, // Default role
				};

				const password = formData.get("Password");
				if (password) {
					data.Password = password;
				}

				const url = isEdit
					? `/api/v1/Trabajadores/${id}`
					: "/api/v1/Trabajadores";
				const method = isEdit ? "PATCH" : "POST";

				try {
					const res = await fetch(url, {
						method: method,
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(data),
					});

					if (res.ok) {
						cerrarModal("modalFormulario");
						mostrarExito(
							isEdit
								? "Empleado actualizado correctamente"
								: "Empleado creado correctamente",
						);
						setTimeout(() => location.reload(), 1500);
					} else {
						const err = await res.json();
						mostrarError(
							err.message || "Error al guardar empleado",
						);
					}
				} catch (error) {
					mostrarError("Error de conexión");
				}
			});

		// Eliminar
		document
			.getElementById("btnConfirmarEliminar")
			.addEventListener("click", async () => {
				if (!selectedEmpleadoId) return;
				try {
					const res = await fetch(
						`/api/v1/Trabajadores/${selectedEmpleadoId}`,
						{
							method: "DELETE",
						},
					);
					if (res.ok) {
						cerrarModal("modalEliminar");
						mostrarExito("Empleado eliminado correctamente");
						setTimeout(() => location.reload(), 1500);
					} else {
						const err = await res.json();
						mostrarError(
							err.message || "Error al eliminar empleado",
						);
					}
				} catch (error) {
					mostrarError("Error de conexión");
				}
			});

		// --- UI Helpers ---
		function mostrarExito(msg) {
			document.getElementById("mensajeExito").textContent = msg;
			document.getElementById("modalExito").classList.remove("hidden");
		}

		function mostrarError(msg) {
			document.getElementById("mensajeError").textContent = msg;
			document.getElementById("modalError").classList.remove("hidden");
		}

		// --- Event Listeners Globales ---
		searchInput.addEventListener("input", (e) => {
			const term = e.target.value.toLowerCase();
			filteredData = allData.filter(
				(item) =>
					(item.FirstName &&
						item.FirstName.toLowerCase().includes(term)) ||
					(item.LastName &&
						item.LastName.toLowerCase().includes(term)) ||
					(item.Email && item.Email.toLowerCase().includes(term)),
			);
			currentPage = 1;
			renderTable();
		});

		rowsPerPageSelect.addEventListener("change", (e) => {
			rowsPerPage = parseInt(e.target.value);
			currentPage = 1;
			renderTable();
		});

		prevBtn.addEventListener("click", () => {
			if (currentPage > 1) {
				currentPage--;
				renderTable();
			}
		});

		nextBtn.addEventListener("click", () => {
			const totalPages = Math.ceil(filteredData.length / rowsPerPage);
			if (currentPage < totalPages) {
				currentPage++;
				renderTable();
			}
		});

		// Inicializar
		renderTable();
	</script>
</Layout>
