---
export const prerender = false;
import NavBar from "../components/NavBar.astro";
import Layout from "../layouts/Layout.astro";
import TopTag from "../components/TopTag.astro";

let clinicData = {};
let scheduleData = [];

const backendUrl =
    import.meta.env.BACKEND_URL || "https://api.jesstherapy.cloud";
const token = Astro.cookies.get("auth_token")?.value;
const headers = {
    "Content-Type": "application/json",
    ...(token && { Cookie: `auth_token=${token}` }),
};

const { Agent } = await import("node:https");
const agent = new Agent({ rejectUnauthorized: false });

try {
    const [clinicRes, scheduleRes] = await Promise.all([
        fetch(`${backendUrl}/api/v1/Clinicas`, { headers, agent }),
        fetch(`${backendUrl}/api/v1/Horarios`, { headers, agent }),
    ]);

    if (clinicRes.ok) {
        const clinics = await clinicRes.json();
        clinicData = clinics[0] || {}; // Assuming we want the first clinic
    }

    if (scheduleRes.ok) {
        scheduleData = await scheduleRes.json();
    }
} catch (error) {
    console.error("Error fetching data:", error);
}

const daysMap = {
    1: "Lunes",
    2: "Martes",
    3: "Miércoles",
    4: "Jueves",
    5: "Viernes",
    6: "Sábado",
    7: "Domingo",
};
---

<Layout title="Configuración">
    <div
        class="flex h-[100dvh] overflow-hidden bg-gradient-to-br from-[#F0F4F8] via-[#E6F0EA] to-[#F0F4F8]"
    >
        <NavBar />
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <!-- Background Elements -->
            <div
                class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-[#2F5D50]/10 rounded-full blur-3xl pointer-events-none"
            >
            </div>
            <div
                class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-[#2F5D50]/5 rounded-full blur-3xl pointer-events-none"
            >
            </div>

            <TopTag
                titulo="Configuración del Sistema"
                nombreUsuario="Administrador"
            />

            <main
                class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scrollbar-thin scrollbar-thumb-[#2F5D50]/20 scrollbar-track-transparent relative z-10"
            >
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Menú lateral -->
                    <div
                        class="lg:w-1/4 glass-panel rounded-3xl p-6 h-fit animate-fade-in-up stagger-2 border border-white/40 shadow-xl"
                    >
                        <h3 class="text-lg font-bold text-[#2F5D50] mb-4 px-2">
                            Menú
                        </h3>
                        <ul class="space-y-2">
                            <li
                                class="p-3 bg-[#2F5D50]/10 text-[#2F5D50] font-bold rounded-xl cursor-pointer border border-[#2F5D50]/20 flex items-center transition-all"
                            >
                                <div
                                    class="w-8 h-8 rounded-lg bg-[#2F5D50]/20 flex items-center justify-center mr-3"
                                >
                                    <i class="fas fa-building"></i>
                                </div>
                                Información de la Clínica
                            </li>
                        </ul>
                    </div>

                    <!-- Panel de configuración -->
                    <div
                        class="lg:w-3/4 space-y-8 animate-fade-in-up stagger-3"
                    >
                        <!-- Información de la Clínica -->
                        <div
                            class="glass-panel rounded-3xl p-8 border border-white/40 shadow-xl relative overflow-hidden"
                        >
                            <div
                                class="absolute top-0 right-0 p-8 opacity-5 pointer-events-none"
                            >
                                <i
                                    class="fas fa-building text-9xl text-[#2F5D50]"
                                ></i>
                            </div>

                            <div
                                class="flex justify-between items-center mb-8 border-b border-[#2F5D50]/10 pb-4"
                            >
                                <h2
                                    class="text-xl font-bold text-[#2F5D50] flex items-center gap-3"
                                >
                                    <div
                                        class="w-10 h-10 rounded-xl bg-[#2F5D50]/10 flex items-center justify-center"
                                    >
                                        <i class="fas fa-building"></i>
                                    </div>
                                    Información de la Clínica
                                </h2>
                                <button
                                    id="btnActualizar"
                                    class="glass-button px-4 py-2 rounded-xl flex items-center gap-2 text-white bg-[#2F5D50] hover:bg-[#234D20] transition-all shadow-lg hover:shadow-[#2F5D50]/30 transform hover:-translate-y-1"
                                >
                                    <i class="fa-solid fa-save"></i>
                                    <span class="font-semibold text-sm"
                                        >Actualizar Datos</span
                                    >
                                </button>
                            </div>

                            <form
                                id="formClinica"
                                class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10"
                            >
                                <input
                                    type="hidden"
                                    id="clinicId"
                                    value={clinicData.id || ""}
                                />
                                <div class="space-y-2">
                                    <label
                                        class="block text-sm font-bold text-gray-700 ml-1"
                                        >Nombre de la Clínica</label
                                    >
                                    <input
                                        type="text"
                                        id="name"
                                        class="glass-input w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                                        value={clinicData.name || ""}
                                    />
                                </div>

                                <div class="space-y-2">
                                    <label
                                        class="block text-sm font-bold text-gray-700 ml-1"
                                        >RFC</label
                                    >
                                    <input
                                        type="text"
                                        id="rfc_clinic"
                                        class="glass-input w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                                        value={clinicData.rfc_clinic || ""}
                                    />
                                </div>

                                <div class="space-y-2">
                                    <label
                                        class="block text-sm font-bold text-gray-700 ml-1"
                                        >Correo Electrónico</label
                                    >
                                    <input
                                        type="email"
                                        id="email"
                                        class="glass-input w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                                        value={clinicData.email || ""}
                                    />
                                </div>

                                <div class="space-y-2">
                                    <label
                                        class="block text-sm font-bold text-gray-700 ml-1"
                                        >Teléfono</label
                                    >
                                    <input
                                        type="tel"
                                        id="phone"
                                        class="glass-input w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                                        value={clinicData.phone || ""}
                                    />
                                </div>

                                <div class="space-y-2 md:col-span-2">
                                    <label
                                        class="block text-sm font-bold text-gray-700 ml-1"
                                        >Dirección</label
                                    >
                                    <input
                                        type="text"
                                        id="address"
                                        class="glass-input w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                                        value={clinicData.address || ""}
                                    />
                                </div>

                                <div class="space-y-2">
                                    <label
                                        class="block text-sm font-bold text-gray-700 ml-1"
                                        >Código Postal</label
                                    >
                                    <input
                                        type="text"
                                        id="postalcode"
                                        class="glass-input w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                                        value={clinicData.postalcode || ""}
                                    />
                                </div>
                            </form>
                        </div>

                        <!-- Configuración de Horarios -->
                        <div
                            class="glass-panel rounded-3xl p-8 border border-white/40 shadow-xl relative overflow-hidden"
                        >
                            <div
                                class="absolute top-0 right-0 p-8 opacity-5 pointer-events-none"
                            >
                                <i class="fas fa-clock text-9xl text-[#2F5D50]"
                                ></i>
                            </div>

                            <h2
                                class="text-xl font-bold mb-8 text-[#2F5D50] flex items-center gap-3 border-b border-[#2F5D50]/10 pb-4"
                            >
                                <div
                                    class="w-10 h-10 rounded-xl bg-[#2F5D50]/10 flex items-center justify-center"
                                >
                                    <i class="fas fa-clock"></i>
                                </div>
                                Horarios de Atención
                            </h2>

                            <div class="space-y-4 relative z-10">
                                {
                                    scheduleData.map((schedule) => (
                                        <div class="flex flex-col sm:flex-row items-center justify-between p-5 bg-white/40 rounded-2xl border border-white/50 hover:bg-white/60 transition-colors gap-4">
                                            <div class="flex items-center gap-3 w-full sm:w-auto">
                                                <div
                                                    class={`w-2 h-2 rounded-full ${schedule.dayofweek >= 1 && schedule.dayofweek <= 5 ? "bg-green-500" : "bg-yellow-500"}`}
                                                />
                                                <span class="font-bold text-gray-700">
                                                    {daysMap[
                                                        schedule.dayofweek
                                                    ] ||
                                                        `Día ${schedule.dayofweek}`}
                                                </span>
                                            </div>
                                            <div class="flex items-center gap-3 w-full sm:w-auto justify-end">
                                                <input
                                                    type="time"
                                                    class="glass-input px-4 py-2 rounded-lg text-sm font-medium"
                                                    value={schedule.openhour}
                                                    readonly
                                                />
                                                <span class="text-gray-400 font-medium">
                                                    a
                                                </span>
                                                <input
                                                    type="time"
                                                    class="glass-input px-4 py-2 rounded-lg text-sm font-medium"
                                                    value={schedule.closehour}
                                                    readonly
                                                />
                                            </div>
                                        </div>
                                    ))
                                }
                                {
                                    scheduleData.length === 0 && (
                                        <p class="text-center text-gray-500">
                                            No hay horarios configurados.
                                        </p>
                                    )
                                }
                            </div>
                        </div>

                        <!-- Configuración de Facturación -->
                        <div
                            class="glass-panel rounded-3xl p-8 border border-white/40 shadow-xl relative overflow-hidden"
                        >
                            <div
                                class="absolute top-0 right-0 p-8 opacity-5 pointer-events-none"
                            >
                                <i
                                    class="fas fa-receipt text-9xl text-[#2F5D50]"
                                ></i>
                            </div>

                            <h2
                                class="text-xl font-bold mb-8 text-[#2F5D50] flex items-center gap-3 border-b border-[#2F5D50]/10 pb-4"
                            >
                                <div
                                    class="w-10 h-10 rounded-xl bg-[#2F5D50]/10 flex items-center justify-center"
                                >
                                    <i class="fas fa-receipt"></i>
                                </div>
                                Configuración de Facturación
                            </h2>

                            <div
                                class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10"
                            >
                                <div class="space-y-2">
                                    <label
                                        class="block text-sm font-bold text-gray-700 ml-1"
                                        >Porcentaje de IVA</label
                                    >
                                    <div class="relative">
                                        <input
                                            type="number"
                                            class="glass-input w-full px-4 py-3 rounded-xl pr-10 focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                                            value="16"
                                            step="0.1"
                                        />
                                        <span
                                            class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold"
                                            >%</span
                                        >
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label
                                        class="block text-sm font-bold text-gray-700 ml-1"
                                        >Moneda</label
                                    >
                                    <div class="relative">
                                        <select
                                            class="glass-input w-full px-4 py-3 rounded-xl appearance-none cursor-pointer focus:ring-2 focus:ring-[#2F5D50]/20 outline-none transition-all"
                                        >
                                            <option value="MXN" selected
                                                >Peso Mexicano (MXN)</option
                                            >
                                            <option value="USD"
                                                >Dólar Americano (USD)</option
                                            >
                                        </select>
                                        <div
                                            class="absolute right-4 top-1/2 -translate-y-1/2 text-[#2F5D50] pointer-events-none"
                                        >
                                            <i
                                                class="fa-solid fa-chevron-down text-xs"
                                            ></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-2 md:col-span-2">
                                    <label
                                        class="flex items-center cursor-pointer group p-4 bg-white/40 rounded-xl border border-white/50 hover:bg-white/60 transition-all"
                                    >
                                        <div class="relative flex items-center">
                                            <input
                                                type="checkbox"
                                                class="peer sr-only"
                                                checked
                                            />
                                            <div
                                                class="w-6 h-6 bg-white border-2 border-gray-300 rounded-md peer-checked:bg-[#2F5D50] peer-checked:border-[#2F5D50] transition-all flex items-center justify-center"
                                            >
                                                <i
                                                    class="fa-solid fa-check text-white text-xs opacity-0 peer-checked:opacity-100 transition-opacity"
                                                ></i>
                                            </div>
                                        </div>
                                        <span
                                            class="ml-3 text-sm font-bold text-gray-700 group-hover:text-[#2F5D50] transition-colors"
                                        >
                                            Generar factura automáticamente al
                                            completar cita
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración de Notificaciones -->
                        <div
                            class="glass-panel rounded-3xl p-8 border border-white/40 shadow-xl relative overflow-hidden"
                        >
                            <div
                                class="absolute top-0 right-0 p-8 opacity-5 pointer-events-none"
                            >
                                <i class="fas fa-bell text-9xl text-[#2F5D50]"
                                ></i>
                            </div>

                            <h2
                                class="text-xl font-bold mb-8 text-[#2F5D50] flex items-center gap-3 border-b border-[#2F5D50]/10 pb-4"
                            >
                                <div
                                    class="w-10 h-10 rounded-xl bg-[#2F5D50]/10 flex items-center justify-center"
                                >
                                    <i class="fas fa-bell"></i>
                                </div>
                                Notificaciones
                            </h2>

                            <div class="space-y-4 relative z-10">
                                <div
                                    class="flex items-center justify-between p-5 bg-white/40 rounded-2xl border border-white/50 hover:bg-white/60 transition-colors"
                                >
                                    <div>
                                        <span
                                            class="font-bold text-gray-800 block text-lg"
                                            >Recordatorio de citas</span
                                        >
                                        <span
                                            class="text-sm text-gray-500 font-medium"
                                            >Enviar recordatorio a pacientes 24h
                                            antes</span
                                        >
                                    </div>
                                    <label
                                        class="relative inline-flex items-center cursor-pointer"
                                    >
                                        <input
                                            type="checkbox"
                                            class="sr-only peer"
                                            checked
                                        />
                                        <div
                                            class="w-14 h-8 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-[#2F5D50] shadow-inner"
                                        >
                                        </div>
                                    </label>
                                </div>

                                <div
                                    class="flex items-center justify-between p-5 bg-white/40 rounded-2xl border border-white/50 hover:bg-white/60 transition-colors"
                                >
                                    <div>
                                        <span
                                            class="font-bold text-gray-800 block text-lg"
                                            >Notificaciones por correo</span
                                        >
                                        <span
                                            class="text-sm text-gray-500 font-medium"
                                            >Enviar resumen diario al
                                            administrador</span
                                        >
                                    </div>
                                    <label
                                        class="relative inline-flex items-center cursor-pointer"
                                    >
                                        <input
                                            type="checkbox"
                                            class="sr-only peer"
                                            checked
                                        />
                                        <div
                                            class="w-14 h-8 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-[#2F5D50] shadow-inner"
                                        >
                                        </div>
                                    </label>
                                </div>

                                <div
                                    class="flex items-center justify-between p-5 bg-white/40 rounded-2xl border border-white/50 hover:bg-white/60 transition-colors"
                                >
                                    <div>
                                        <span
                                            class="font-bold text-gray-800 block text-lg"
                                            >Alertas de Stock</span
                                        >
                                        <span
                                            class="text-sm text-gray-500 font-medium"
                                            >Notificar cuando un producto esté
                                            bajo de stock</span
                                        >
                                    </div>
                                    <label
                                        class="relative inline-flex items-center cursor-pointer"
                                    >
                                        <input
                                            type="checkbox"
                                            class="sr-only peer"
                                        />
                                        <div
                                            class="w-14 h-8 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-[#2F5D50] shadow-inner"
                                        >
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const btnActualizar = document.getElementById("btnActualizar");
            const clinicId = document.getElementById("clinicId").value;

            btnActualizar.addEventListener("click", async () => {
                const data = {
                    name: document.getElementById("name").value,
                    rfc_clinic: document.getElementById("rfc_clinic").value,
                    email: document.getElementById("email").value,
                    phone: document.getElementById("phone").value,
                    address: document.getElementById("address").value,
                    postalcode: document.getElementById("postalcode").value,
                };

                // Si no hay ID, asumimos que es 1 o manejamos el error
                const targetId = clinicId || "1";

                try {
                    const response = await fetch(
                        `/api/v1/Clinicas/${targetId}`,
                        {
                            method: "PATCH",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(data),
                        },
                    );

                    if (response.ok) {
                        alert("Datos actualizados correctamente");
                        // Opcional: recargar para ver cambios si es necesario, aunque los inputs ya tienen los nuevos valores
                    } else {
                        const err = await response.json();
                        alert(
                            "Error al actualizar: " +
                                (err.message || response.statusText),
                        );
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error de conexión al actualizar los datos");
                }
            });
        });
    </script>
</Layout>
